
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>basic-server: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">jobfirst-basic/cmd/basic-server/main.go (0.0%)</option>
				
				<option value="file1">jobfirst-basic/internal/auth/handler.go (0.0%)</option>
				
				<option value="file2">jobfirst-basic/internal/handlers/ai_chat_handler.go (0.0%)</option>
				
				<option value="file3">jobfirst-basic/internal/handlers/banners.go (0.0%)</option>
				
				<option value="file4">jobfirst-basic/internal/handlers/chat_handler.go (0.0%)</option>
				
				<option value="file5">jobfirst-basic/internal/handlers/companies.go (0.0%)</option>
				
				<option value="file6">jobfirst-basic/internal/handlers/jobs.go (0.0%)</option>
				
				<option value="file7">jobfirst-basic/internal/handlers/notification_handler.go (0.0%)</option>
				
				<option value="file8">jobfirst-basic/internal/handlers/points_handler.go (0.0%)</option>
				
				<option value="file9">jobfirst-basic/internal/handlers/resume_v3_handler.go (0.0%)</option>
				
				<option value="file10">jobfirst-basic/internal/models/job.go (0.0%)</option>
				
				<option value="file11">jobfirst-basic/pkg/cache/redis.go (0.0%)</option>
				
				<option value="file12">jobfirst-basic/pkg/config/config.go (0.0%)</option>
				
				<option value="file13">jobfirst-basic/pkg/consul/manager.go (0.0%)</option>
				
				<option value="file14">jobfirst-basic/pkg/consul/microservice_registry.go (0.0%)</option>
				
				<option value="file15">jobfirst-basic/pkg/database/mysql.go (0.0%)</option>
				
				<option value="file16">jobfirst-basic/pkg/middleware/middleware.go (0.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

import (
        "bytes"
        "context"
        "fmt"
        "io"
        "log"
        "net/http"
        "os"
        "os/signal"
        "strconv"
        "syscall"
        "time"

        "github.com/gin-contrib/cors"
        "github.com/gin-gonic/gin"
        "github.com/joho/godotenv"
        "golang.org/x/crypto/bcrypt"
        "gorm.io/driver/mysql"
        "gorm.io/gorm"

        "jobfirst-basic/internal/handlers"
        "jobfirst-basic/pkg/cache"
        "jobfirst-basic/pkg/config"
        "jobfirst-basic/pkg/consul"
        "jobfirst-basic/pkg/database"
        "jobfirst-basic/pkg/middleware"
)

func main() <span class="cov0" title="0">{
        // 加载环境配置
        if err := godotenv.Load(); err != nil </span><span class="cov0" title="0">{
                log.Println("No .env file found, using default configuration")
        }</span>

        // 初始化配置
        <span class="cov0" title="0">cfg := config.Load()

        // 初始化数据库连接
        db, err := database.InitMySQL(cfg.Database)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to connect to database: %v", err)
        }</span>
        <span class="cov0" title="0">defer database.CloseMySQL(db)

        // 初始化GORM数据库连接（用于V3.0 API）
        dsn := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=utf8mb4&amp;parseTime=True&amp;loc=Local",
                cfg.Database.User,
                cfg.Database.Password,
                cfg.Database.Host,
                cfg.Database.Port,
                cfg.Database.Name,
        )
        gormDB, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to connect to database with GORM: %v", err)
        }</span>

        // 初始化Redis缓存
        <span class="cov0" title="0">redisClient, err := cache.InitRedis(cfg.Redis)
        if err != nil </span><span class="cov0" title="0">{
                log.Fatalf("Failed to connect to Redis: %v", err)
        }</span>
        <span class="cov0" title="0">defer cache.CloseRedis(redisClient)

        // 初始化Consul服务管理器
        var consulManager *consul.ServiceManager
        var microserviceRegistry *consul.MicroserviceRegistry
        if cfg.Consul.Enabled </span><span class="cov0" title="0">{
                consulManager, err = consul.NewServiceManager(&amp;cfg.Consul)
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Warning: Failed to initialize Consul manager: %v", err)
                        log.Println("Continuing without Consul service discovery")
                }</span> else<span class="cov0" title="0"> {
                        defer consulManager.Close()
                        log.Println("Consul service manager initialized successfully")

                        // 初始化微服务注册器
                        microserviceRegistry = consul.NewMicroserviceRegistry(consulManager)

                        // 注册默认微服务
                        if err := microserviceRegistry.RegisterDefaultServices(cfg); err != nil </span><span class="cov0" title="0">{
                                log.Printf("Warning: Failed to register default microservices: %v", err)
                        }</span>

                        // 启动定期健康检查
                        <span class="cov0" title="0">go microserviceRegistry.StartPeriodicHealthCheck(30 * time.Second)</span>
                }
        } else<span class="cov0" title="0"> {
                log.Println("Consul service discovery is disabled")
        }</span>

        // 设置Gin模式
        <span class="cov0" title="0">if cfg.Environment == "production" </span><span class="cov0" title="0">{
                gin.SetMode(gin.ReleaseMode)
        }</span>

        // 创建Gin路由
        <span class="cov0" title="0">router := gin.Default()

        // 配置CORS
        router.Use(cors.New(cors.Config{
                AllowOrigins:     []string{"*"},
                AllowMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
                AllowHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization", "API-Version", "X-Requested-With", "X-API-Key", "X-Client-Version"},
                ExposeHeaders:    []string{"Content-Length"},
                AllowCredentials: true,
                MaxAge:           12 * time.Hour,
        }))

        // 中间件
        router.Use(middleware.Logger())
        router.Use(middleware.Recovery())
        router.Use(middleware.RequestID())

        // 健康检查
        router.GET("/health", func(c *gin.Context) </span><span class="cov0" title="0">{
                // 检查数据库连接
                dbHealthy := true
                if err := db.Ping(); err != nil </span><span class="cov0" title="0">{
                        dbHealthy = false
                }</span>

                // 检查Redis连接
                <span class="cov0" title="0">redisHealthy := true
                ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
                defer cancel()
                if err := redisClient.Ping(ctx).Err(); err != nil </span><span class="cov0" title="0">{
                        redisHealthy = false
                }</span>

                // 检查Consul连接
                <span class="cov0" title="0">consulHealthy := false
                if consulManager != nil </span><span class="cov0" title="0">{
                        consulHealthy = consulManager.IsHealthy()
                }</span>

                // 整体健康状态
                <span class="cov0" title="0">overallHealthy := dbHealthy &amp;&amp; redisHealthy
                if consulManager != nil </span><span class="cov0" title="0">{
                        overallHealthy = overallHealthy &amp;&amp; consulHealthy
                }</span>

                <span class="cov0" title="0">statusCode := http.StatusOK
                if !overallHealthy </span><span class="cov0" title="0">{
                        statusCode = http.StatusServiceUnavailable
                }</span>

                <span class="cov0" title="0">c.JSON(statusCode, gin.H{
                        "status":    overallHealthy,
                        "timestamp": time.Now().Format(time.RFC3339),
                        "version":   "1.0.0",
                        "mode":      "basic",
                        "checks": gin.H{
                                "database": gin.H{
                                        "status": dbHealthy,
                                        "type":   "mysql",
                                },
                                "cache": gin.H{
                                        "status": redisHealthy,
                                        "type":   "redis",
                                },
                                "consul": gin.H{
                                        "status":  consulHealthy,
                                        "enabled": consulManager != nil,
                                },
                        },
                        "services": gin.H{
                                "basic_server":   "running",
                                "user_service":   "http://localhost:8081",
                                "resume_service": "http://localhost:8082",
                                "ai_service":     "http://localhost:8206",
                        },
                })</span>
        })

        // 处理所有OPTIONS请求
        <span class="cov0" title="0">router.OPTIONS("/api/v1/*any", func(c *gin.Context) </span><span class="cov0" title="0">{
                c.Header("Access-Control-Allow-Origin", "*")
                c.Header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
                c.Header("Access-Control-Allow-Headers", "Origin, Content-Type, Accept, Authorization, API-Version, X-Requested-With, X-API-Key, X-Client-Version")
                c.Header("Access-Control-Max-Age", "86400")
                c.Status(http.StatusOK)
        }</span>)

        // API路由组
        <span class="cov0" title="0">api := router.Group("/api/v1")
        </span><span class="cov0" title="0">{

                // 服务状态路由
                api.GET("/status", func(c *gin.Context) </span><span class="cov0" title="0">{
                        c.JSON(http.StatusOK, gin.H{
                                "status": "running",
                                "services": gin.H{
                                        "basic_server": gin.H{
                                                "status": "running",
                                                "port":   cfg.Server.Port,
                                                "health": fmt.Sprintf("http://localhost:%s/health", cfg.Server.Port),
                                        },
                                        "user_service": gin.H{
                                                "status": "running",
                                                "port":   "8081",
                                                "health": "http://localhost:8081/health",
                                        },
                                        "resume_service": gin.H{
                                                "status": "running",
                                                "port":   "8082",
                                                "health": "http://localhost:8082/health",
                                        },
                                },
                                "database": gin.H{
                                        "mysql": "connected",
                                        "redis": "connected",
                                },
                        })
                }</span>)

                // 系统信息路由
                <span class="cov0" title="0">api.GET("/info", func(c *gin.Context) </span><span class="cov0" title="0">{
                        c.JSON(http.StatusOK, gin.H{
                                "name":        "JobFirst Basic Version",
                                "description": "个人简历管理系统 - 基础版本",
                                "version":     "1.0.0",
                                "environment": cfg.Environment,
                                "mode":        cfg.Mode,
                                "timestamp":   time.Now().Format(time.RFC3339),
                        })
                }</span>)

                // 数据库状态路由
                <span class="cov0" title="0">api.GET("/database/status", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 检查MySQL连接
                        mysqlStatus := "connected"
                        if err := db.Ping(); err != nil </span><span class="cov0" title="0">{
                                mysqlStatus = "disconnected"
                        }</span>

                        // 检查Redis连接
                        <span class="cov0" title="0">redisStatus := "connected"
                        ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
                        defer cancel()
                        if err := redisClient.Ping(ctx).Err(); err != nil </span><span class="cov0" title="0">{
                                redisStatus = "disconnected"
                        }</span>

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "mysql": gin.H{
                                        "status": mysqlStatus,
                                        "host":   cfg.Database.Host,
                                        "port":   cfg.Database.Port,
                                        "name":   cfg.Database.Name,
                                },
                                "redis": gin.H{
                                        "status": redisStatus,
                                        "host":   cfg.Redis.Host,
                                        "port":   cfg.Redis.Port,
                                },
                        })</span>
                })

                // Consul状态路由
                <span class="cov0" title="0">api.GET("/consul/status", func(c *gin.Context) </span><span class="cov0" title="0">{
                        if consulManager == nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusOK, gin.H{
                                        "enabled": false,
                                        "message": "Consul service discovery is disabled",
                                })
                                return
                        }</span>

                        <span class="cov0" title="0">status := consulManager.GetConsulStatus()
                        c.JSON(http.StatusOK, status)</span>
                })

                // 服务发现路由
                <span class="cov0" title="0">api.GET("/consul/services", func(c *gin.Context) </span><span class="cov0" title="0">{
                        if consulManager == nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusOK, gin.H{
                                        "enabled": false,
                                        "message": "Consul service discovery is disabled",
                                })
                                return
                        }</span>

                        <span class="cov0" title="0">services, err := consulManager.ListServices()
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{
                                        "error": err.Error(),
                                })
                                return
                        }</span>

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "enabled":  true,
                                "services": services,
                        })</span>
                })

                // 微服务注册信息路由
                <span class="cov0" title="0">api.GET("/consul/microservices", func(c *gin.Context) </span><span class="cov0" title="0">{
                        if microserviceRegistry == nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusOK, gin.H{
                                        "enabled": false,
                                        "message": "Microservice registry is disabled",
                                })
                                return
                        }</span>

                        <span class="cov0" title="0">info := microserviceRegistry.GetServiceDiscoveryInfo()
                        c.JSON(http.StatusOK, info)</span>
                })

                // 微服务健康检查路由
                <span class="cov0" title="0">api.GET("/consul/health", func(c *gin.Context) </span><span class="cov0" title="0">{
                        if microserviceRegistry == nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusOK, gin.H{
                                        "enabled": false,
                                        "message": "Microservice registry is disabled",
                                })
                                return
                        }</span>

                        <span class="cov0" title="0">healthResults := microserviceRegistry.HealthCheckAll()
                        c.JSON(http.StatusOK, gin.H{
                                "enabled":      true,
                                "health_check": healthResults,
                                "timestamp":    time.Now().Format(time.RFC3339),
                        })</span>
                })

                // 用户管理API
                <span class="cov0" title="0">api.GET("/users", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 从数据库获取用户列表
                        var users []map[string]interface{}
                        rows, err := db.Query("SELECT id, username, email, phone, status, created_at FROM users LIMIT 10")
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
                                return
                        }</span>
                        <span class="cov0" title="0">defer rows.Close()

                        for rows.Next() </span><span class="cov0" title="0">{
                                var id int
                                var username, email, phone, status string
                                var createdAt time.Time

                                if err := rows.Scan(&amp;id, &amp;username, &amp;email, &amp;phone, &amp;status, &amp;createdAt); err != nil </span><span class="cov0" title="0">{
                                        continue</span>
                                }

                                <span class="cov0" title="0">user := map[string]interface{}{
                                        "id":         id,
                                        "username":   username,
                                        "email":      email,
                                        "phone":      phone,
                                        "status":     status,
                                        "created_at": createdAt.Format("2006-01-02 15:04:05"),
                                }
                                users = append(users, user)</span>
                        }

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "status": "success",
                                "data":   users,
                                "count":  len(users),
                        })</span>
                })

                // 简历管理API
                <span class="cov0" title="0">api.GET("/resumes", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 从数据库获取简历列表
                        var resumes []map[string]interface{}
                        rows, err := db.Query("SELECT r.id, r.title, r.template_id, r.status, r.view_count, r.share_count, r.created_at, u.username FROM resumes r LEFT JOIN users u ON r.user_id = u.id LIMIT 10")
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
                                return
                        }</span>
                        <span class="cov0" title="0">defer rows.Close()

                        for rows.Next() </span><span class="cov0" title="0">{
                                var id int
                                var title, templateID, status, username string
                                var viewCount, shareCount int
                                var createdAt time.Time

                                if err := rows.Scan(&amp;id, &amp;title, &amp;templateID, &amp;status, &amp;viewCount, &amp;shareCount, &amp;createdAt, &amp;username); err != nil </span><span class="cov0" title="0">{
                                        continue</span>
                                }

                                <span class="cov0" title="0">resume := map[string]interface{}{
                                        "id":          id,
                                        "title":       title,
                                        "template_id": templateID,
                                        "status":      status,
                                        "view_count":  viewCount,
                                        "share_count": shareCount,
                                        "username":    username,
                                        "created_at":  createdAt.Format("2006-01-02 15:04:05"),
                                }
                                resumes = append(resumes, resume)</span>
                        }

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "status": "success",
                                "data":   resumes,
                                "count":  len(resumes),
                        })</span>
                })

                // 职位管理API
                <span class="cov0" title="0">api.GET("/jobs", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 从数据库获取职位列表
                        var jobs []map[string]interface{}
                        rows, err := db.Query("SELECT id, title, company, location, salary_min, salary_max, status, created_at FROM jobs LIMIT 10")
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
                                return
                        }</span>
                        <span class="cov0" title="0">defer rows.Close()

                        for rows.Next() </span><span class="cov0" title="0">{
                                var id int
                                var title, company, location, status string
                                var salaryMin, salaryMax int
                                var createdAt time.Time

                                if err := rows.Scan(&amp;id, &amp;title, &amp;company, &amp;location, &amp;salaryMin, &amp;salaryMax, &amp;status, &amp;createdAt); err != nil </span><span class="cov0" title="0">{
                                        continue</span>
                                }

                                <span class="cov0" title="0">job := map[string]interface{}{
                                        "id":         id,
                                        "title":      title,
                                        "company":    company,
                                        "location":   location,
                                        "salary_min": salaryMin,
                                        "salary_max": salaryMax,
                                        "status":     status,
                                        "created_at": createdAt.Format("2006-01-02 15:04:05"),
                                }
                                jobs = append(jobs, job)</span>
                        }

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "status": "success",
                                "data":   jobs,
                                "count":  len(jobs),
                        })</span>
                })

                // 积分管理API
                <span class="cov0" title="0">api.GET("/points", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 从数据库获取积分列表
                        var points []map[string]interface{}
                        rows, err := db.Query("SELECT p.id, p.balance, p.created_at, u.username FROM points p LEFT JOIN users u ON p.user_id = u.id LIMIT 10")
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
                                return
                        }</span>
                        <span class="cov0" title="0">defer rows.Close()

                        for rows.Next() </span><span class="cov0" title="0">{
                                var id, balance int
                                var username string
                                var createdAt time.Time

                                if err := rows.Scan(&amp;id, &amp;balance, &amp;createdAt, &amp;username); err != nil </span><span class="cov0" title="0">{
                                        continue</span>
                                }

                                <span class="cov0" title="0">point := map[string]interface{}{
                                        "id":         id,
                                        "balance":    balance,
                                        "username":   username,
                                        "created_at": createdAt.Format("2006-01-02 15:04:05"),
                                }
                                points = append(points, point)</span>
                        }

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "status": "success",
                                "data":   points,
                                "count":  len(points),
                        })</span>
                })

                // 用户登录API
                <span class="cov0" title="0">api.POST("/auth/login", func(c *gin.Context) </span><span class="cov0" title="0">{
                        var loginData struct {
                                Username string `json:"username"`
                                Password string `json:"password"`
                        }

                        if err := c.ShouldBindJSON(&amp;loginData); err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request data"})
                                return
                        }</span>

                        // 简单的用户验证（实际项目中应该使用加密密码）
                        <span class="cov0" title="0">var id int
                        var username, email, phone, passwordHash string
                        err := db.QueryRow("SELECT id, username, email, phone, password_hash FROM users WHERE username = ? LIMIT 1", loginData.Username).Scan(&amp;id, &amp;username, &amp;email, &amp;phone, &amp;passwordHash)
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid credentials"})
                                return
                        }</span>

                        // 验证密码 - 支持明文密码和bcrypt哈希
                        <span class="cov0" title="0">fmt.Printf("Debug: username=%s, password=%s, passwordHash=%s\n", loginData.Username, loginData.Password, passwordHash)

                        // 检查是否是bcrypt哈希（以$2a$或$2b$开头）
                        if len(passwordHash) &gt; 4 &amp;&amp; (passwordHash[:4] == "$2a$" || passwordHash[:4] == "$2b$") </span><span class="cov0" title="0">{
                                // 使用bcrypt验证
                                err = bcrypt.CompareHashAndPassword([]byte(passwordHash), []byte(loginData.Password))
                                if err != nil </span><span class="cov0" title="0">{
                                        c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid credentials"})
                                        return
                                }</span>
                        } else<span class="cov0" title="0"> {
                                // 明文密码比较
                                if loginData.Password != passwordHash </span><span class="cov0" title="0">{
                                        c.JSON(http.StatusUnauthorized, gin.H{"error": "Invalid credentials"})
                                        return
                                }</span>
                        }

                        <span class="cov0" title="0">user := map[string]interface{}{
                                "id":       id,
                                "username": username,
                                "email":    email,
                                "phone":    phone,
                        }

                        // 生成简单的JWT token（实际项目中应该使用proper JWT）
                        token := fmt.Sprintf("token_%s_%d", loginData.Username, time.Now().Unix())

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "Login successful",
                                "data": gin.H{
                                        "token": token,
                                        "user":  user,
                                },
                        })</span>
                })

                // 用户注册API
                <span class="cov0" title="0">api.POST("/auth/register", func(c *gin.Context) </span><span class="cov0" title="0">{
                        var registerData struct {
                                Username string `json:"username"`
                                Email    string `json:"email"`
                                Password string `json:"password"`
                                Phone    string `json:"phone"`
                        }

                        if err := c.ShouldBindJSON(&amp;registerData); err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request data"})
                                return
                        }</span>

                        // 检查用户是否已存在
                        <span class="cov0" title="0">var count int
                        err := db.QueryRow("SELECT COUNT(*) FROM users WHERE username = ? OR email = ?", registerData.Username, registerData.Email).Scan(&amp;count)
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": "Database error"})
                                return
                        }</span>
                        <span class="cov0" title="0">if count &gt; 0 </span><span class="cov0" title="0">{
                                c.JSON(http.StatusConflict, gin.H{"error": "User already exists"})
                                return
                        }</span>

                        // 创建新用户
                        <span class="cov0" title="0">_, err = db.Exec("INSERT INTO users (username, email, password_hash, phone) VALUES (?, ?, ?, ?)",
                                registerData.Username, registerData.Email, registerData.Password, registerData.Phone)

                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to create user"})
                                return
                        }</span>

                        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "User registered successfully",
                        })</span>
                })

                // 微信登录API
                <span class="cov0" title="0">api.POST("/auth/wechat-login", func(c *gin.Context) </span><span class="cov0" title="0">{
                        var wechatData struct {
                                Code     string `json:"code"`
                                Nickname string `json:"nickname"`
                                Avatar   string `json:"avatar"`
                        }

                        if err := c.ShouldBindJSON(&amp;wechatData); err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request data"})
                                return
                        }</span>

                        // 模拟微信登录验证（实际项目中应该调用微信API验证code）
                        // 这里我们创建一个测试用户或返回现有用户
                        <span class="cov0" title="0">var userID int
                        var username, email, phone string

                        // 尝试查找现有用户（基于微信code或昵称）
                        err := db.QueryRow("SELECT id, username, email, phone FROM users WHERE username = ? LIMIT 1", wechatData.Nickname).Scan(&amp;userID, &amp;username, &amp;email, &amp;phone)

                        if err != nil </span><span class="cov0" title="0">{
                                // 用户不存在，创建新用户
                                username = wechatData.Nickname
                                if username == "" </span><span class="cov0" title="0">{
                                        codePrefix := wechatData.Code
                                        if len(codePrefix) &gt; 8 </span><span class="cov0" title="0">{
                                                codePrefix = codePrefix[:8]
                                        }</span>
                                        <span class="cov0" title="0">username = "微信用户_" + codePrefix</span>
                                }
                                <span class="cov0" title="0">email = username + "@wechat.local"
                                phone = ""

                                // 生成UUID，确保Code长度足够
                                codePrefix := wechatData.Code
                                if len(codePrefix) &gt; 8 </span><span class="cov0" title="0">{
                                        codePrefix = codePrefix[:8]
                                }</span>
                                <span class="cov0" title="0">uuid := fmt.Sprintf("wechat_%s_%d", codePrefix, time.Now().Unix())

                                result, err := db.Exec("INSERT INTO users (uuid, username, email, password_hash, phone, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())",
                                        uuid, username, email, "wechat_user", phone, "active")
                                if err != nil </span><span class="cov0" title="0">{
                                        c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to create user: " + err.Error()})
                                        return
                                }</span>

                                <span class="cov0" title="0">userID64, _ := result.LastInsertId()
                                userID = int(userID64)</span>
                        }

                        <span class="cov0" title="0">user := map[string]interface{}{
                                "id":       userID,
                                "username": username,
                                "email":    email,
                                "phone":    phone,
                                "avatar":   wechatData.Avatar,
                        }

                        // 生成JWT token
                        token := fmt.Sprintf("wechat_token_%s_%d", username, time.Now().Unix())

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "微信登录成功",
                                "data": gin.H{
                                        "token": token,
                                        "user":  user,
                                },
                        })</span>
                })

                // 发送验证码API
                <span class="cov0" title="0">api.POST("/user/sendCode", func(c *gin.Context) </span><span class="cov0" title="0">{
                        var request struct {
                                Phone string `json:"phone"`
                        }

                        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request data"})
                                return
                        }</span>

                        // 模拟发送验证码
                        <span class="cov0" title="0">code := fmt.Sprintf("%06d", time.Now().Unix()%1000000)

                        // 这里应该调用短信服务发送验证码
                        // 暂时返回成功响应
                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "验证码发送成功",
                                "data": gin.H{
                                        "code": code, // 开发环境返回验证码，生产环境不应该返回
                                },
                        })</span>
                })

                // 微信注册API
                <span class="cov0" title="0">api.POST("/user/wechatRegister", func(c *gin.Context) </span><span class="cov0" title="0">{
                        var request struct {
                                Code     string `json:"code"`
                                Nickname string `json:"nickname"`
                                Avatar   string `json:"avatar"`
                                Phone    string `json:"phone"`
                        }

                        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusBadRequest, gin.H{"error": "Invalid request data"})
                                return
                        }</span>

                        // 检查用户是否已存在
                        <span class="cov0" title="0">var userID int
                        var username, email string

                        err := db.QueryRow("SELECT id, username, email FROM users WHERE username = ? OR phone = ? LIMIT 1",
                                request.Nickname, request.Phone).Scan(&amp;userID, &amp;username, &amp;email)

                        if err == nil </span><span class="cov0" title="0">{
                                // 用户已存在
                                c.JSON(http.StatusOK, gin.H{
                                        "status":  "success",
                                        "message": "用户已存在，直接登录",
                                        "data": gin.H{
                                                "user": map[string]interface{}{
                                                        "id":       userID,
                                                        "username": username,
                                                        "email":    email,
                                                        "phone":    request.Phone,
                                                        "avatar":   request.Avatar,
                                                },
                                                "token": fmt.Sprintf("wechat_token_%s_%d", username, time.Now().Unix()),
                                        },
                                })
                                return
                        }</span>

                        // 创建新用户
                        <span class="cov0" title="0">username = request.Nickname
                        if username == "" </span><span class="cov0" title="0">{
                                codePrefix := request.Code
                                if len(codePrefix) &gt; 8 </span><span class="cov0" title="0">{
                                        codePrefix = codePrefix[:8]
                                }</span>
                                <span class="cov0" title="0">username = "微信用户_" + codePrefix</span>
                        }
                        <span class="cov0" title="0">email = username + "@wechat.local"

                        // 生成UUID，确保Code长度足够
                        codePrefix := request.Code
                        if len(codePrefix) &gt; 8 </span><span class="cov0" title="0">{
                                codePrefix = codePrefix[:8]
                        }</span>
                        <span class="cov0" title="0">uuid := fmt.Sprintf("wechat_%s_%d", codePrefix, time.Now().Unix())

                        result, err := db.Exec("INSERT INTO users (uuid, username, email, password_hash, phone, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())",
                                uuid, username, email, "wechat_user", request.Phone, "active")
                        if err != nil </span><span class="cov0" title="0">{
                                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to create user: " + err.Error()})
                                return
                        }</span>

                        <span class="cov0" title="0">userID64, _ := result.LastInsertId()
                        userID = int(userID64)

                        user := map[string]interface{}{
                                "id":       userID,
                                "username": username,
                                "email":    email,
                                "phone":    request.Phone,
                                "avatar":   request.Avatar,
                        }

                        token := fmt.Sprintf("wechat_token_%s_%d", username, time.Now().Unix())

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "微信注册成功",
                                "data": gin.H{
                                        "token": token,
                                        "user":  user,
                                },
                        })</span>
                })

                // 轮播图API
                <span class="cov0" title="0">api.GET("/banner/list", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 返回轮播图数据
                        banners := []map[string]interface{}{
                                {
                                        "id":    1,
                                        "image": "/images/banner1.svg",
                                        "title": "JobFirst智能简历管理",
                                        "link":  "/pages/resume/resume",
                                },
                                {
                                        "id":    2,
                                        "image": "/images/banner2.svg",
                                        "title": "AI助手，简历优化更轻松",
                                        "link":  "/pages/chat/chat",
                                },
                        }

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "获取成功",
                                "data":    banners,
                        })
                }</span>)

                // 推荐职位API
                <span class="cov0" title="0">api.GET("/job/recommend", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 返回推荐职位数据
                        jobs := []map[string]interface{}{
                                {
                                        "id":       1,
                                        "title":    "前端开发工程师",
                                        "company":  "JobFirst科技",
                                        "salary":   "15K-25K",
                                        "location": "深圳",
                                        "tags":     []string{"React", "Vue", "JavaScript"},
                                },
                                {
                                        "id":       2,
                                        "title":    "后端开发工程师",
                                        "company":  "JobFirst科技",
                                        "salary":   "20K-35K",
                                        "location": "深圳",
                                        "tags":     []string{"Go", "Gin", "MySQL"},
                                },
                                {
                                        "id":       3,
                                        "title":    "产品经理",
                                        "company":  "JobFirst科技",
                                        "salary":   "25K-40K",
                                        "location": "深圳",
                                        "tags":     []string{"产品设计", "用户研究", "数据分析"},
                                },
                        }

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "获取成功",
                                "data":    jobs,
                        })
                }</span>)

                // 市场统计数据API
                <span class="cov0" title="0">api.GET("/statistics/market", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 返回市场统计数据
                        marketData := map[string]interface{}{
                                "jobCount":     "5,000+",
                                "companyCount": "200+",
                                "avgSalary":    "18K",
                                "growthRate":   "15%",
                        }

                        c.JSON(http.StatusOK, gin.H{
                                "status":  "success",
                                "message": "获取成功",
                                "data":    marketData,
                        })
                }</span>)
        }

        // ==================== AI服务代理路由组 ====================
        // AI服务代理 - 转发请求到AI服务
        <span class="cov0" title="0">aiAPI := router.Group("/api/v1/ai")
        </span><span class="cov0" title="0">{
                // AI聊天功能
                aiAPI.POST("/chat", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/ai/chat", "POST")
                }</span>)

                // AI功能列表
                <span class="cov0" title="0">aiAPI.GET("/features", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/ai/features", "GET")
                }</span>)

                // 开始AI分析
                <span class="cov0" title="0">aiAPI.POST("/start-analysis", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/ai/start-analysis", "POST")
                }</span>)

                // 获取分析结果
                <span class="cov0" title="0">aiAPI.GET("/analysis-result/:taskId", func(c *gin.Context) </span><span class="cov0" title="0">{
                        taskId := c.Param("taskId")
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/ai/analysis-result/"+taskId, "GET")
                }</span>)

                // 获取聊天历史
                <span class="cov0" title="0">aiAPI.GET("/chat-history", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/ai/chat-history", "GET")
                }</span>)
        }

        // 简历分析API代理
        <span class="cov0" title="0">analyzeAPI := router.Group("/api/v1/analyze")
        </span><span class="cov0" title="0">{
                analyzeAPI.POST("/resume", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/analyze/resume", "POST")
                }</span>)
        }

        // 向量操作API代理
        <span class="cov0" title="0">vectorsAPI := router.Group("/api/v1/vectors")
        </span><span class="cov0" title="0">{
                vectorsAPI.GET("/:resume_id", func(c *gin.Context) </span><span class="cov0" title="0">{
                        resumeId := c.Param("resume_id")
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/vectors/"+resumeId, "GET")
                }</span>)

                <span class="cov0" title="0">vectorsAPI.POST("/search", func(c *gin.Context) </span><span class="cov0" title="0">{
                        // 转发到AI服务
                        proxyToAIService(c, "/api/v1/vectors/search", "POST")
                }</span>)
        }

        // ==================== V3.0 API路由组 ====================
        // 初始化V3.0处理器
        <span class="cov0" title="0">resumeV3Handler := handlers.NewResumeV3Handler(gormDB)

        // 添加V3.0 API路由组
        v2API := router.Group("/api/v2")
        // v2API.Use(authMiddleware()) // 暂时注释掉认证中间件，便于测试
        </span><span class="cov0" title="0">{
                // 简历管理API（目前可用的方法）
                v2API.GET("/resumes", resumeV3Handler.GetResumes)
                v2API.POST("/resumes", resumeV3Handler.CreateResume)
                v2API.GET("/resumes/:id", resumeV3Handler.GetResume)

                // 标准化数据API
                v2API.GET("/standard/skills", resumeV3Handler.GetSkills)
                v2API.GET("/standard/companies", resumeV3Handler.GetCompanies)
                v2API.GET("/standard/positions", resumeV3Handler.GetPositions)
        }</span>

        // 启动服务器
        <span class="cov0" title="0">srv := &amp;http.Server{
                Addr:    fmt.Sprintf(":%s", cfg.Server.Port),
                Handler: router,
        }

        // 优雅关闭
        go func() </span><span class="cov0" title="0">{
                if err := srv.ListenAndServe(); err != nil &amp;&amp; err != http.ErrServerClosed </span><span class="cov0" title="0">{
                        log.Fatalf("Failed to start server: %v", err)
                }</span>
        }()

        <span class="cov0" title="0">log.Printf("Basic Version API Gateway started on port %s", cfg.Server.Port)
        log.Printf("User Service: http://localhost:8081")
        log.Printf("Resume Service: http://localhost:8082")

        // 注册服务到Consul
        if consulManager != nil </span><span class="cov0" title="0">{
                port, _ := strconv.Atoi(cfg.Server.Port)
                err = consulManager.RegisterService(
                        cfg.Consul.ServiceName,
                        cfg.Consul.ServiceID,
                        cfg.Server.Host,
                        port,
                        cfg.Consul.ServiceTags,
                )
                if err != nil </span><span class="cov0" title="0">{
                        log.Printf("Warning: Failed to register service to Consul: %v", err)
                }</span> else<span class="cov0" title="0"> {
                        log.Printf("Service registered to Consul: %s (%s)", cfg.Consul.ServiceName, cfg.Consul.ServiceID)

                        // 启动健康检查循环
                        go consulManager.StartHealthCheckLoop()
                }</span>
        }

        // 等待中断信号
        <span class="cov0" title="0">quit := make(chan os.Signal, 1)
        signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
        &lt;-quit

        log.Println("Shutting down server...")

        ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
        defer cancel()

        if err := srv.Shutdown(ctx); err != nil </span><span class="cov0" title="0">{
                log.Fatal("Server forced to shutdown:", err)
        }</span>

        <span class="cov0" title="0">log.Println("Server exited")</span>
}

// proxyToAIService 代理请求到AI服务
func proxyToAIService(c *gin.Context, path string, method string) <span class="cov0" title="0">{
        // AI服务URL
        aiServiceURL := "http://localhost:8206"

        // 构建完整URL
        url := aiServiceURL + path

        // 读取请求体
        var body []byte
        if c.Request.Body != nil </span><span class="cov0" title="0">{
                body, _ = io.ReadAll(c.Request.Body)
                c.Request.Body = io.NopCloser(bytes.NewBuffer(body))
        }</span>

        // 创建新的HTTP请求
        <span class="cov0" title="0">req, err := http.NewRequest(method, url, bytes.NewBuffer(body))
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to create request"})
                return
        }</span>

        // 复制请求头
        <span class="cov0" title="0">for key, values := range c.Request.Header </span><span class="cov0" title="0">{
                for _, value := range values </span><span class="cov0" title="0">{
                        req.Header.Add(key, value)
                }</span>
        }

        // 发送请求
        <span class="cov0" title="0">client := &amp;http.Client{Timeout: 30 * time.Second}
        resp, err := client.Do(req)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusServiceUnavailable, gin.H{"error": "AI service unavailable"})
                return
        }</span>
        <span class="cov0" title="0">defer resp.Body.Close()

        // 读取响应
        respBody, err := io.ReadAll(resp.Body)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to read response"})
                return
        }</span>

        // 复制响应头
        <span class="cov0" title="0">for key, values := range resp.Header </span><span class="cov0" title="0">{
                for _, value := range values </span><span class="cov0" title="0">{
                        c.Header(key, value)
                }</span>
        }

        // 返回响应
        <span class="cov0" title="0">c.Data(resp.StatusCode, resp.Header.Get("Content-Type"), respBody)</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package auth

import (
        "net/http"
        "time"

        "github.com/gin-gonic/gin"
        "github.com/golang-jwt/jwt/v5"
        "golang.org/x/crypto/bcrypt"
)

type Handler struct {
        db    interface{}
        redis interface{}
}

type User struct {
        ID       uint   `json:"id"`
        Email    string `json:"email"`
        Username string `json:"username"`
        Password string `json:"password"`
}

type LoginRequest struct {
        Email    string `json:"email" binding:"required,email"`
        Password string `json:"password" binding:"required"`
}

type RegisterRequest struct {
        Email    string `json:"email" binding:"required,email"`
        Username string `json:"username" binding:"required"`
        Password string `json:"password" binding:"required,min=6"`
}

type AuthResponse struct {
        Token        string `json:"token"`
        RefreshToken string `json:"refresh_token"`
        User         User   `json:"user"`
}

func NewHandler(db interface{}, redis interface{}) *Handler <span class="cov0" title="0">{
        return &amp;Handler{
                db:    db,
                redis: redis,
        }
}</span>

func (h *Handler) Register(c *gin.Context) <span class="cov0" title="0">{
        var req RegisterRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
                return
        }</span>

        // 这里应该添加数据库操作
        // 暂时返回成功响应
        <span class="cov0" title="0">user := User{
                ID:       1,
                Email:    req.Email,
                Username: req.Username,
        }

        // 生成JWT token
        token, err := h.generateToken(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate token"})
                return
        }</span>

        <span class="cov0" title="0">refreshToken, err := h.generateRefreshToken(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate refresh token"})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusCreated, AuthResponse{
                Token:        token,
                RefreshToken: refreshToken,
                User:         user,
        })</span>
}

func (h *Handler) Login(c *gin.Context) <span class="cov0" title="0">{
        var req LoginRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
                return
        }</span>

        // 这里应该验证用户凭据
        // 暂时返回成功响应
        <span class="cov0" title="0">user := User{
                ID:       1,
                Email:    req.Email,
                Username: "user",
        }

        // 生成JWT token
        token, err := h.generateToken(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate token"})
                return
        }</span>

        <span class="cov0" title="0">refreshToken, err := h.generateRefreshToken(user.ID)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"error": "Failed to generate refresh token"})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, AuthResponse{
                Token:        token,
                RefreshToken: refreshToken,
                User:         user,
        })</span>
}

func (h *Handler) Logout(c *gin.Context) <span class="cov0" title="0">{
        // 这里应该使token失效
        c.JSON(http.StatusOK, gin.H{"message": "Logged out successfully"})
}</span>

func (h *Handler) RefreshToken(c *gin.Context) <span class="cov0" title="0">{
        // 这里应该验证refresh token并生成新的access token
        c.JSON(http.StatusOK, gin.H{"message": "Token refreshed successfully"})
}</span>

func (h *Handler) generateToken(userID uint) (string, error) <span class="cov0" title="0">{
        token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{
                "user_id": userID,
                "exp":     time.Now().Add(time.Hour * 24).Unix(),
                "iat":     time.Now().Unix(),
        })

        return token.SignedString([]byte("your-secret-key"))
}</span>

func (h *Handler) generateRefreshToken(userID uint) (string, error) <span class="cov0" title="0">{
        token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims{
                "user_id": userID,
                "exp":     time.Now().Add(time.Hour * 24 * 7).Unix(),
                "iat":     time.Now().Unix(),
        })

        return token.SignedString([]byte("your-refresh-secret-key"))
}</span>

func hashPassword(password string) (string, error) <span class="cov0" title="0">{
        bytes, err := bcrypt.GenerateFromPassword([]byte(password), 12)
        return string(bytes), err
}</span>

func checkPassword(password, hash string) bool <span class="cov0" title="0">{
        err := bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
        return err == nil
}</span>
</pre>
		
		<pre class="file" id="file2" style="display: none">package handlers

import (
        "bytes"
        "encoding/json"
        "fmt"
        "io"
        "net/http"
        "time"

        "github.com/gin-gonic/gin"
)

type AIChatHandler struct {
        AIServiceURL string
}

func NewAIChatHandler(aiServiceURL string) *AIChatHandler <span class="cov0" title="0">{
        return &amp;AIChatHandler{
                AIServiceURL: aiServiceURL,
        }
}</span>

// ChatRequest AI聊天请求结构
type ChatRequest struct {
        Message string `json:"message" binding:"required"`
        Context *any   `json:"context,omitempty"`
}

// ChatResponse AI聊天响应结构
type ChatResponse struct {
        Answer      string   `json:"answer"`
        Suggestions []string `json:"suggestions"`
}

// AIAnalysisRequest AI分析请求结构
type AIAnalysisRequest struct {
        FeatureID int    `json:"featureId" binding:"required"`
        Content   string `json:"content" binding:"required"`
        Type      string `json:"type" binding:"required"`
        Params    *any   `json:"params,omitempty"`
}

// AIAnalysisResponse AI分析响应结构
type AIAnalysisResponse struct {
        TaskID        string `json:"taskId"`
        EstimatedTime int    `json:"estimatedTime"`
}

// AIAnalysisResult AI分析结果结构
type AIAnalysisResult struct {
        Score           int                `json:"score"`
        Suggestions     []string           `json:"suggestions"`
        Keywords        []string           `json:"keywords"`
        IndustryMatch   map[string]float64 `json:"industryMatch"`
        Competitiveness string             `json:"competitiveness"`
}

// Chat 处理AI聊天请求
func (h *AIChatHandler) Chat(c *gin.Context) <span class="cov0" title="0">{
        var req ChatRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 调用AI服务进行聊天
        <span class="cov0" title="0">response, err := h.callAIService("/api/v1/ai/chat", req)
        if err != nil </span><span class="cov0" title="0">{
                // 如果AI服务不可用，返回模拟数据
                c.JSON(http.StatusOK, gin.H{
                        "code": 200,
                        "data": ChatResponse{
                                Answer: fmt.Sprintf("这是一个模拟的AI回答。您的问题是：%s。在实际应用中，这里会返回基于您问题的智能回答。", req.Message),
                                Suggestions: []string{
                                        "如何优化简历？",
                                        "面试技巧有哪些？",
                                        "职业规划建议",
                                        "技能提升方向",
                                },
                        },
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "data": response,
        })</span>
}

// StartAnalysis 开始AI分析
func (h *AIChatHandler) StartAnalysis(c *gin.Context) <span class="cov0" title="0">{
        var req AIAnalysisRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 调用AI服务开始分析
        <span class="cov0" title="0">response, err := h.callAIService("/api/v1/ai/start-analysis", req)
        if err != nil </span><span class="cov0" title="0">{
                // 如果AI服务不可用，返回模拟数据
                taskID := fmt.Sprintf("task_%d", time.Now().Unix())
                c.JSON(http.StatusOK, gin.H{
                        "code": 200,
                        "data": AIAnalysisResponse{
                                TaskID:        taskID,
                                EstimatedTime: 30,
                        },
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "data": response,
        })</span>
}

// GetAnalysisResult 获取AI分析结果
func (h *AIChatHandler) GetAnalysisResult(c *gin.Context) <span class="cov0" title="0">{
        taskID := c.Param("taskId")
        if taskID == "" </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Task ID is required",
                })
                return
        }</span>

        // 调用AI服务获取分析结果
        <span class="cov0" title="0">response, err := h.callAIService(fmt.Sprintf("/api/v1/ai/analysis-result/%s", taskID), nil)
        if err != nil </span><span class="cov0" title="0">{
                // 如果AI服务不可用，返回模拟数据
                c.JSON(http.StatusOK, gin.H{
                        "code": 200,
                        "data": AIAnalysisResult{
                                Score: 75,
                                Suggestions: []string{
                                        "完善技能描述，添加具体的技术栈",
                                        "增加项目经验描述，突出成果",
                                        "优化教育背景展示",
                                        "添加相关证书和培训经历",
                                },
                                Keywords: []string{
                                        "技术开发",
                                        "软件工程",
                                        "项目管理",
                                        "团队协作",
                                },
                                IndustryMatch: map[string]float64{
                                        "互联网": 0.85,
                                        "金融":  0.70,
                                        "教育":  0.60,
                                        "医疗":  0.45,
                                },
                                Competitiveness: "中等偏上",
                        },
                })
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "data": response,
        })</span>
}

// GetAIFeatures 获取AI功能列表
func (h *AIChatHandler) GetAIFeatures(c *gin.Context) <span class="cov0" title="0">{
        // 返回AI功能列表
        features := []gin.H{
                {
                        "id":          1,
                        "title":       "简历优化",
                        "description": "AI智能分析简历，提供优化建议",
                        "icon":        "📝",
                        "points":      10,
                        "available":   true,
                        "features":    []string{"内容分析", "格式优化", "关键词提取", "行业匹配"},
                },
                {
                        "id":          2,
                        "title":       "面试准备",
                        "description": "AI模拟面试，提供面试技巧和建议",
                        "icon":        "🎯",
                        "points":      15,
                        "available":   true,
                        "features":    []string{"模拟面试", "问题预测", "回答建议", "技巧指导"},
                },
                {
                        "id":          3,
                        "title":       "职业规划",
                        "description": "AI分析职业发展路径，提供规划建议",
                        "icon":        "🗺️",
                        "points":      20,
                        "available":   true,
                        "features":    []string{"路径分析", "技能评估", "发展建议", "目标设定"},
                },
                {
                        "id":          4,
                        "title":       "薪资谈判",
                        "description": "AI分析市场薪资，提供谈判策略",
                        "icon":        "💰",
                        "points":      12,
                        "available":   true,
                        "features":    []string{"薪资分析", "市场对比", "谈判技巧", "策略建议"},
                },
        }

        c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "data": features,
        })
}</span>

// GetChatHistory 获取聊天历史
func (h *AIChatHandler) GetChatHistory(c *gin.Context) <span class="cov0" title="0">{
        // 返回模拟聊天历史
        history := []gin.H{
                {
                        "id":        1,
                        "message":   "如何优化我的简历？",
                        "type":      "user",
                        "timestamp": time.Now().Add(-2 * time.Hour).Format(time.RFC3339),
                },
                {
                        "id":        2,
                        "message":   "简历优化需要从多个方面入手：1. 突出核心技能 2. 量化工作成果 3. 优化关键词 4. 完善项目经验",
                        "type":      "ai",
                        "timestamp": time.Now().Add(-2*time.Hour + 1*time.Minute).Format(time.RFC3339),
                },
                {
                        "id":        3,
                        "message":   "面试时如何回答'为什么选择我们公司'这个问题？",
                        "type":      "user",
                        "timestamp": time.Now().Add(-1 * time.Hour).Format(time.RFC3339),
                },
                {
                        "id":        4,
                        "message":   "回答这个问题时，建议从以下几个方面入手：1. 公司文化和价值观 2. 行业地位和发展前景 3. 个人职业规划匹配 4. 具体业务兴趣",
                        "type":      "ai",
                        "timestamp": time.Now().Add(-1*time.Hour + 1*time.Minute).Format(time.RFC3339),
                },
        }

        c.JSON(http.StatusOK, gin.H{
                "code": 200,
                "data": gin.H{
                        "history": history,
                        "total":   len(history),
                },
        })
}</span>

// callAIService 调用AI服务的通用方法
func (h *AIChatHandler) callAIService(endpoint string, data interface{}) (interface{}, error) <span class="cov0" title="0">{
        url := h.AIServiceURL + endpoint

        var body io.Reader
        if data != nil </span><span class="cov0" title="0">{
                jsonData, err := json.Marshal(data)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov0" title="0">body = bytes.NewBuffer(jsonData)</span>
        }

        <span class="cov0" title="0">req, err := http.NewRequest("POST", url, body)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">req.Header.Set("Content-Type", "application/json")

        client := &amp;http.Client{
                Timeout: 30 * time.Second,
        }

        resp, err := client.Do(req)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">defer resp.Body.Close()

        if resp.StatusCode != http.StatusOK </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("AI service returned status %d", resp.StatusCode)
        }</span>

        <span class="cov0" title="0">var result interface{}
        if err := json.NewDecoder(resp.Body).Decode(&amp;result); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return result, nil</span>
}
</pre>
		
		<pre class="file" id="file3" style="display: none">package handlers

import (
        "net/http"

        "github.com/gin-gonic/gin"
)

// BannerHandler 轮播图处理器
type BannerHandler struct {
        // 这里可以注入数据库连接、缓存等依赖
}

// NewBannerHandler 创建轮播图处理器
func NewBannerHandler() *BannerHandler <span class="cov0" title="0">{
        return &amp;BannerHandler{}
}</span>

// GetBannersV2 获取轮播图列表（新版本）
func (h *BannerHandler) GetBannersV2(c *gin.Context) <span class="cov0" title="0">{
        // 从新数据库表获取轮播图数据
        banners := []map[string]interface{}{
                {
                        "id":          1,
                        "title":       "春季招聘会",
                        "image_url":   "/images/banner1.jpg",
                        "link_url":    "/pages/activity/spring",
                        "link_type":   "internal",
                        "sort_order":  1,
                        "status":      "active",
                        "view_count":  1250,
                        "click_count": 89,
                        "created_at":  "2024-08-30T10:00:00Z",
                },
                {
                        "id":          2,
                        "title":       "名企直招",
                        "image_url":   "/images/banner2.jpg",
                        "link_url":    "/pages/activity/companies",
                        "link_type":   "internal",
                        "sort_order":  2,
                        "status":      "active",
                        "view_count":  980,
                        "click_count": 67,
                        "created_at":  "2024-08-30T10:00:00Z",
                },
                {
                        "id":          3,
                        "title":       "应届生专场",
                        "image_url":   "/images/banner3.jpg",
                        "link_url":    "/pages/activity/fresh",
                        "link_type":   "internal",
                        "sort_order":  3,
                        "status":      "active",
                        "view_count":  756,
                        "click_count": 45,
                        "created_at":  "2024-08-30T10:00:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "banners":  banners,
                        "total":    len(banners),
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package handlers

import (
        "net/http"
        "strconv"
        "time"

        "github.com/gin-gonic/gin"
)

type ChatHandler struct{}

func NewChatHandler() *ChatHandler <span class="cov0" title="0">{
        return &amp;ChatHandler{}
}</span>

// GetChatSessions 获取聊天会话列表
func (h *ChatHandler) GetChatSessions(c *gin.Context) <span class="cov0" title="0">{
        // 模拟聊天会话数据
        sessions := []map[string]interface{}{
                {
                        "session_id":        "session_001",
                        "session_type":      "job_apply",
                        "title":             "前端开发工程师申请",
                        "description":       "关于前端开发工程师职位的申请沟通",
                        "participants":      []int{1, 2},
                        "last_message_id":   5,
                        "last_message_time": "2024-08-30T16:30:00Z",
                        "unread_count":      2,
                        "status":            "active",
                        "created_at":        "2024-08-30T10:00:00Z",
                },
                {
                        "session_id":        "session_002",
                        "session_type":      "hr_chat",
                        "title":             "HR面试沟通",
                        "description":       "与HR的面试安排沟通",
                        "participants":      []int{1, 3},
                        "last_message_id":   8,
                        "last_message_time": "2024-08-30T15:45:00Z",
                        "unread_count":      0,
                        "status":            "active",
                        "created_at":        "2024-08-30T09:00:00Z",
                },
                {
                        "session_id":        "session_003",
                        "session_type":      "system_notice",
                        "title":             "系统通知",
                        "description":       "系统重要通知",
                        "participants":      []int{1},
                        "last_message_id":   12,
                        "last_message_time": "2024-08-30T14:20:00Z",
                        "unread_count":      1,
                        "status":            "active",
                        "created_at":        "2024-08-30T08:00:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "sessions": sessions,
                        "total":    len(sessions),
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// GetChatMessages 获取聊天消息
func (h *ChatHandler) GetChatMessages(c *gin.Context) <span class="cov0" title="0">{
        sessionID := c.Param("sessionId")
        page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))

        // 模拟聊天消息数据
        messages := []map[string]interface{}{
                {
                        "id":             1,
                        "session_id":     sessionID,
                        "sender_id":      2,
                        "sender_type":    "hr",
                        "message_type":   "text",
                        "content":        "您好，我们已经收到您的简历，请问您什么时候方便面试？",
                        "read_status":    map[string]string{"1": "2024-08-30T16:35:00Z"},
                        "created_at":     "2024-08-30T16:30:00Z",
                },
                {
                        "id":             2,
                        "session_id":     sessionID,
                        "sender_id":      1,
                        "sender_type":    "user",
                        "message_type":   "text",
                        "content":        "您好，我明天下午2点有空，可以安排面试吗？",
                        "read_status":    map[string]string{"2": "2024-08-30T16:32:00Z"},
                        "created_at":     "2024-08-30T16:31:00Z",
                },
                {
                        "id":             3,
                        "session_id":     sessionID,
                        "sender_id":      2,
                        "sender_type":    "hr",
                        "message_type":   "text",
                        "content":        "好的，明天下午2点面试，请准时参加。面试地点：公司大楼3楼会议室",
                        "read_status":    map[string]string{},
                        "created_at":     "2024-08-30T16:33:00Z",
                },
                {
                        "id":             4,
                        "session_id":     sessionID,
                        "sender_id":      1,
                        "sender_type":    "user",
                        "message_type":   "text",
                        "content":        "收到，谢谢！我会准时到达的。",
                        "read_status":    map[string]string{},
                        "created_at":     "2024-08-30T16:34:00Z",
                },
                {
                        "id":             5,
                        "session_id":     sessionID,
                        "sender_id":      2,
                        "sender_type":    "hr",
                        "message_type":   "job_card",
                        "content":        "这是您申请的职位详情",
                        "job_id":         1,
                        "read_status":    map[string]string{},
                        "created_at":     "2024-08-30T16:35:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "messages": messages,
                        "total":    len(messages),
                        "page":     page,
                        "limit":    limit,
                        "session_id": sessionID,
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// SendMessage 发送消息
func (h *ChatHandler) SendMessage(c *gin.Context) <span class="cov0" title="0">{
        sessionID := c.Param("sessionId")
        
        var request struct {
                Content       string `json:"content" binding:"required"`
                MessageType   string `json:"message_type" binding:"required"`
                ReplyToID     *int   `json:"reply_to_id"`
                JobID         *int   `json:"job_id"`
                ResumeID      *int   `json:"resume_id"`
                AttachmentURL string `json:"attachment_url"`
        }

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 模拟发送消息
        <span class="cov0" title="0">message := map[string]interface{}{
                "id":             6,
                "session_id":     sessionID,
                "sender_id":      1,
                "sender_type":    "user",
                "message_type":   request.MessageType,
                "content":        request.Content,
                "read_status":    map[string]string{},
                "reply_to_id":    request.ReplyToID,
                "job_id":         request.JobID,
                "resume_id":      request.ResumeID,
                "attachment_url": request.AttachmentURL,
                "created_at":     time.Now().Format("2006-01-02T15:04:05Z"),
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "Message sent successfully",
                "data": map[string]interface{}{
                        "message":   message,
                        "session_id": sessionID,
                        "version":   "v2",
                        "database":  "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// MarkMessageRead 标记消息已读
func (h *ChatHandler) MarkMessageRead(c *gin.Context) <span class="cov0" title="0">{
        sessionID := c.Param("sessionId")
        messageID := c.Param("messageId")

        response := map[string]interface{}{
                "code":    200,
                "message": "Message marked as read",
                "data": map[string]interface{}{
                        "session_id": sessionID,
                        "message_id": messageID,
                        "read_time":  time.Now().Format("2006-01-02T15:04:05Z"),
                        "version":    "v2",
                        "database":   "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// CreateChatSession 创建聊天会话
func (h *ChatHandler) CreateChatSession(c *gin.Context) <span class="cov0" title="0">{
        var request struct {
                SessionType  string   `json:"session_type" binding:"required"`
                Title        string   `json:"title" binding:"required"`
                Description  string   `json:"description"`
                Participants []int    `json:"participants" binding:"required"`
        }

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 模拟创建会话
        <span class="cov0" title="0">session := map[string]interface{}{
                "session_id":        "session_" + strconv.FormatInt(time.Now().Unix(), 10),
                "session_type":      request.SessionType,
                "title":             request.Title,
                "description":       request.Description,
                "participants":      request.Participants,
                "last_message_id":   nil,
                "last_message_time": nil,
                "unread_count":      0,
                "status":            "active",
                "created_at":        time.Now().Format("2006-01-02T15:04:05Z"),
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "Chat session created successfully",
                "data": map[string]interface{}{
                        "session":  session,
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package handlers

import (
        "net/http"

        "github.com/gin-gonic/gin"
)

// CompanyHandler 企业处理器
type CompanyHandler struct {
        // 这里可以注入数据库连接、缓存等依赖
}

// NewCompanyHandler 创建企业处理器
func NewCompanyHandler() *CompanyHandler <span class="cov0" title="0">{
        return &amp;CompanyHandler{}
}</span>

// GetCompaniesV2 获取企业列表（新版本）
func (h *CompanyHandler) GetCompaniesV2(c *gin.Context) <span class="cov0" title="0">{
        // 从新数据库表获取企业数据
        companies := []map[string]interface{}{
                {
                        "id":                 1,
                        "name":               "腾讯科技有限公司",
                        "short_name":         "腾讯",
                        "logo_url":           "/images/company/tencent.png",
                        "industry":           "互联网",
                        "company_size":       "enterprise",
                        "location":           "深圳",
                        "website":            "https://www.tencent.com",
                        "description":        "腾讯是一家以互联网为基础的科技与文化公司",
                        "founded_year":       1998,
                        "status":             "verified",
                        "verification_level": "vip",
                        "job_count":          156,
                        "view_count":         12580,
                        "created_at":         "2024-08-30T10:00:00Z",
                },
                {
                        "id":                 2,
                        "name":               "阿里巴巴集团",
                        "short_name":         "阿里巴巴",
                        "logo_url":           "/images/company/alibaba.png",
                        "industry":           "电商",
                        "company_size":       "enterprise",
                        "location":           "杭州",
                        "website":            "https://www.alibaba.com",
                        "description":        "阿里巴巴集团是全球领先的电子商务平台",
                        "founded_year":       1999,
                        "status":             "verified",
                        "verification_level": "vip",
                        "job_count":          89,
                        "view_count":         9876,
                        "created_at":         "2024-08-30T10:00:00Z",
                },
                {
                        "id":                 3,
                        "name":               "字节跳动科技有限公司",
                        "short_name":         "字节跳动",
                        "logo_url":           "/images/company/bytedance.png",
                        "industry":           "互联网",
                        "company_size":       "large",
                        "location":           "北京",
                        "website":            "https://www.bytedance.com",
                        "description":        "字节跳动是一家信息科技公司",
                        "founded_year":       2012,
                        "status":             "verified",
                        "verification_level": "premium",
                        "job_count":          234,
                        "view_count":         15678,
                        "created_at":         "2024-08-30T10:00:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "companies": companies,
                        "total":     len(companies),
                        "version":   "v2",
                        "database":  "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// GetCompanyDetailV2 获取企业详情（新版本）
func (h *CompanyHandler) GetCompanyDetailV2(c *gin.Context) <span class="cov0" title="0">{
        _ = c.Param("id") // 暂时未使用，后续会用于数据库查询

        companyDetail := map[string]interface{}{
                "id":                 1,
                "name":               "腾讯科技有限公司",
                "short_name":         "腾讯",
                "logo_url":           "/images/company/tencent.png",
                "industry":           "互联网",
                "company_size":       "enterprise",
                "location":           "深圳",
                "website":            "https://www.tencent.com",
                "description":        "腾讯是一家以互联网为基础的科技与文化公司，通过技术丰富互联网用户的生活，助力企业数字化升级。我们的使命是\"用户为本 科技向善\"。",
                "founded_year":       1998,
                "business_license":   "91440300708461136T",
                "status":             "verified",
                "verification_level": "vip",
                "job_count":          156,
                "view_count":         12580,
                "created_at":         "2024-08-30T10:00:00Z",
                "jobs": []map[string]interface{}{
                        {
                                "id":    1,
                                "title": "前端开发工程师",
                        },
                        {
                                "id":    2,
                                "title": "后端开发工程师",
                        },
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data":    companyDetail,
        }

        c.JSON(http.StatusOK, response)
}</span>
</pre>
		
		<pre class="file" id="file6" style="display: none">package handlers

import (
        "net/http"
        "strconv"

        "jobfirst-basic/internal/models"

        "github.com/gin-gonic/gin"
        "gorm.io/gorm"
)

// JobHandler 职位处理器
type JobHandler struct {
        db *gorm.DB
}

// NewJobHandler 创建职位处理器
func NewJobHandler() *JobHandler <span class="cov0" title="0">{
        // 使用全局数据库连接
        return &amp;JobHandler{
                db: getGlobalDB(),
        }
}</span>

// getGlobalDB 获取全局数据库连接
func getGlobalDB() *gorm.DB <span class="cov0" title="0">{
        // 从main包获取数据库连接
        // 这里需要导入main包，但由于循环依赖问题，我们暂时使用一个全局变量
        // 在实际项目中，应该使用依赖注入容器
        return globalDB
}</span>

// 全局数据库连接变量
var globalDB *gorm.DB

// SetGlobalDB 设置全局数据库连接
func SetGlobalDB(db *gorm.DB) <span class="cov0" title="0">{
        globalDB = db
}</span>

// GetJobsV2 获取职位列表（新版本）
func (h *JobHandler) GetJobsV2(c *gin.Context) <span class="cov0" title="0">{
        // 获取查询参数
        limit := 10
        if limitStr := c.Query("limit"); limitStr != "" </span><span class="cov0" title="0">{
                if l, err := strconv.Atoi(limitStr); err == nil &amp;&amp; l &gt; 0 </span><span class="cov0" title="0">{
                        limit = l
                }</span>
        }

        // 从数据库查询职位数据
        <span class="cov0" title="0">var jobs []models.Job
        query := h.db.Preload("Company").Preload("Category").Where("status = ?", "published")

        if err := query.Limit(limit).Order("priority DESC, created_at DESC").Find(&amp;jobs).Error; err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "code":    500,
                        "message": "Failed to fetch jobs",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 转换为前端需要的格式
        <span class="cov0" title="0">var result []map[string]interface{}
        for _, job := range jobs </span><span class="cov0" title="0">{
                jobData := map[string]interface{}{
                        "id":                  job.ID,
                        "title":               job.Title,
                        "company_id":          job.CompanyID,
                        "company_name":        job.Company.Name,
                        "company_short_name":  job.Company.ShortName,
                        "company_logo":        job.Company.LogoURL,
                        "location":            job.Location,
                        "salary_min":          job.SalaryMin,
                        "salary_max":          job.SalaryMax,
                        "salary_type":         job.SalaryType,
                        "experience_required": job.ExperienceRequired,
                        "education_required":  job.EducationRequired,
                        "job_type":            job.JobType,
                        "status":              job.Status,
                        "view_count":          job.ViewCount,
                        "application_count":   job.ApplicationCount,
                        "favorite_count":      job.FavoriteCount,
                        "created_at":          job.CreatedAt,
                }
                result = append(result, jobData)
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data":    result,
        })</span>
}

// GetJobDetailV2 获取职位详情（新版本）
func (h *JobHandler) GetJobDetailV2(c *gin.Context) <span class="cov0" title="0">{
        jobID := c.Param("id")

        // 从数据库查询职位详情
        var job models.Job
        if err := h.db.Preload("Company").Preload("Category").Where("id = ? AND status = ?", jobID, "published").First(&amp;job).Error; err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusNotFound, gin.H{
                        "code":    404,
                        "message": "Job not found",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 转换为前端需要的格式
        <span class="cov0" title="0">jobData := map[string]interface{}{
                "id":                  job.ID,
                "title":               job.Title,
                "company_id":          job.CompanyID,
                "company_name":        job.Company.Name,
                "company_short_name":  job.Company.ShortName,
                "company_logo":        job.Company.LogoURL,
                "location":            job.Location,
                "salary_min":          job.SalaryMin,
                "salary_max":          job.SalaryMax,
                "salary_type":         job.SalaryType,
                "experience_required": job.ExperienceRequired,
                "education_required":  job.EducationRequired,
                "job_type":            job.JobType,
                "status":              job.Status,
                "description":         job.Description,
                "requirements":        job.Requirements,
                "benefits":            job.Benefits,
                "skills":              job.Skills,
                "tags":                job.Tags,
                "view_count":          job.ViewCount,
                "application_count":   job.ApplicationCount,
                "favorite_count":      job.FavoriteCount,
                "created_at":          job.CreatedAt,
        }

        c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data":    jobData,
        })</span>
}

// SearchJobsV2 搜索职位（新版本）
func (h *JobHandler) SearchJobsV2(c *gin.Context) <span class="cov0" title="0">{
        // 获取搜索参数
        keyword := c.Query("keyword")
        location := c.Query("location")
        experience := c.Query("experience")

        // 构建查询条件
        query := h.db.Preload("Company").Preload("Category").Where("status = ?", "published")

        if keyword != "" </span><span class="cov0" title="0">{
                query = query.Where("title LIKE ? OR description LIKE ?", "%"+keyword+"%", "%"+keyword+"%")
        }</span>

        <span class="cov0" title="0">if location != "" </span><span class="cov0" title="0">{
                query = query.Where("location LIKE ?", "%"+location+"%")
        }</span>

        <span class="cov0" title="0">if experience != "" </span><span class="cov0" title="0">{
                query = query.Where("experience_required = ?", experience)
        }</span>

        // 执行查询
        <span class="cov0" title="0">var jobs []models.Job
        if err := query.Order("priority DESC, created_at DESC").Find(&amp;jobs).Error; err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{
                        "code":    500,
                        "message": "Failed to search jobs",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 转换为前端需要的格式
        <span class="cov0" title="0">var result []map[string]interface{}
        for _, job := range jobs </span><span class="cov0" title="0">{
                jobData := map[string]interface{}{
                        "id":                  job.ID,
                        "title":               job.Title,
                        "company_id":          job.CompanyID,
                        "company_name":        job.Company.Name,
                        "company_short_name":  job.Company.ShortName,
                        "company_logo":        job.Company.LogoURL,
                        "location":            job.Location,
                        "salary_min":          job.SalaryMin,
                        "salary_max":          job.SalaryMax,
                        "salary_type":         job.SalaryType,
                        "experience_required": job.ExperienceRequired,
                        "education_required":  job.EducationRequired,
                        "job_type":            job.JobType,
                        "status":              job.Status,
                        "view_count":          job.ViewCount,
                        "application_count":   job.ApplicationCount,
                        "favorite_count":      job.FavoriteCount,
                        "created_at":          job.CreatedAt,
                }
                result = append(result, jobData)
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data":    result,
        })</span>
}
</pre>
		
		<pre class="file" id="file7" style="display: none">package handlers

import (
        "net/http"
        "strconv"
        "time"

        "github.com/gin-gonic/gin"
)

type NotificationHandler struct{}

func NewNotificationHandler() *NotificationHandler <span class="cov0" title="0">{
        return &amp;NotificationHandler{}
}</span>

// GetNotifications 获取通知列表
func (h *NotificationHandler) GetNotifications(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))
        notificationType := c.Query("type")
        readStatus := c.Query("read_status")

        // 模拟通知数据
        notifications := []map[string]interface{}{
                {
                        "id":                 1,
                        "user_id":            userID,
                        "notification_type":  "job_apply",
                        "title":              "申请成功",
                        "content":            "您申请的职位\"前端开发工程师\"已成功提交，我们会尽快为您安排面试。",
                        "data": map[string]interface{}{
                                "job_id":    1,
                                "job_title": "前端开发工程师",
                                "company":   "腾讯科技有限公司",
                        },
                        "read_status":        "unread",
                        "read_time":          nil,
                        "send_status":        "sent",
                        "send_time":          "2024-08-30T16:30:00Z",
                        "expire_time":        "2024-09-30T16:30:00Z",
                        "created_at":         "2024-08-30T16:30:00Z",
                },
                {
                        "id":                 2,
                        "user_id":            userID,
                        "notification_type":  "resume_view",
                        "title":              "简历被查看",
                        "content":            "您的简历被\"阿里巴巴集团\"查看，请保持电话畅通。",
                        "data": map[string]interface{}{
                                "company_id":   2,
                                "company_name": "阿里巴巴集团",
                                "view_time":    "2024-08-30T15:45:00Z",
                        },
                        "read_status":        "read",
                        "read_time":          "2024-08-30T16:00:00Z",
                        "send_status":        "sent",
                        "send_time":          "2024-08-30T15:45:00Z",
                        "expire_time":        "2024-09-30T15:45:00Z",
                        "created_at":         "2024-08-30T15:45:00Z",
                },
                {
                        "id":                 3,
                        "user_id":            userID,
                        "notification_type":  "chat_message",
                        "title":              "新消息",
                        "content":            "您收到来自\"HR张经理\"的新消息：请问您明天下午2点有空面试吗？",
                        "data": map[string]interface{}{
                                "sender_id":   2,
                                "sender_name": "HR张经理",
                                "session_id":  "session_001",
                                "message_id":  5,
                        },
                        "read_status":        "unread",
                        "read_time":          nil,
                        "send_status":        "sent",
                        "send_time":          "2024-08-30T14:20:00Z",
                        "expire_time":        "2024-09-30T14:20:00Z",
                        "created_at":         "2024-08-30T14:20:00Z",
                },
                {
                        "id":                 4,
                        "user_id":            userID,
                        "notification_type":  "points_earned",
                        "title":              "获得积分",
                        "content":            "恭喜您获得10积分！每日签到",
                        "data": map[string]interface{}{
                                "points":      10,
                                "reason":      "每日签到",
                                "rule_code":   "DAILY_CHECKIN",
                                "balance":     1250,
                        },
                        "read_status":        "read",
                        "read_time":          "2024-08-30T08:30:00Z",
                        "send_status":        "sent",
                        "send_time":          "2024-08-30T08:00:00Z",
                        "expire_time":        "2024-09-30T08:00:00Z",
                        "created_at":         "2024-08-30T08:00:00Z",
                },
                {
                        "id":                 5,
                        "user_id":            userID,
                        "notification_type":  "system_announcement",
                        "title":              "系统公告",
                        "content":            "系统将于今晚22:00-24:00进行维护升级，期间可能影响部分功能使用，请提前做好准备。",
                        "data": map[string]interface{}{
                                "announcement_id": 1,
                                "priority":        "high",
                                "category":        "maintenance",
                        },
                        "read_status":        "unread",
                        "read_time":          nil,
                        "send_status":        "sent",
                        "send_time":          "2024-08-30T10:00:00Z",
                        "expire_time":        "2024-09-30T10:00:00Z",
                        "created_at":         "2024-08-30T10:00:00Z",
                },
        }

        // 根据查询条件过滤
        filteredNotifications := notifications
        if notificationType != "" </span><span class="cov0" title="0">{
                var filtered []map[string]interface{}
                for _, notification := range filteredNotifications </span><span class="cov0" title="0">{
                        if notification["notification_type"] == notificationType </span><span class="cov0" title="0">{
                                filtered = append(filtered, notification)
                        }</span>
                }
                <span class="cov0" title="0">filteredNotifications = filtered</span>
        }

        <span class="cov0" title="0">if readStatus != "" </span><span class="cov0" title="0">{
                var filtered []map[string]interface{}
                for _, notification := range filteredNotifications </span><span class="cov0" title="0">{
                        if notification["read_status"] == readStatus </span><span class="cov0" title="0">{
                                filtered = append(filtered, notification)
                        }</span>
                }
                <span class="cov0" title="0">filteredNotifications = filtered</span>
        }

        <span class="cov0" title="0">response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "notifications": filteredNotifications,
                        "total":         len(filteredNotifications),
                        "page":          page,
                        "limit":         limit,
                        "unread_count":  3, // 统计未读数量
                        "version":       "v2",
                        "database":      "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetNotificationDetail 获取通知详情
func (h *NotificationHandler) GetNotificationDetail(c *gin.Context) <span class="cov0" title="0">{
        _ = c.Param("id") // 暂时不使用notificationID
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        // 模拟通知详情数据
        <span class="cov0" title="0">notification := map[string]interface{}{
                "id":                 1,
                "user_id":            userID,
                "notification_type":  "job_apply",
                "title":              "申请成功",
                "content":            "您申请的职位\"前端开发工程师\"已成功提交，我们会尽快为您安排面试。",
                "data": map[string]interface{}{
                        "job_id":    1,
                        "job_title": "前端开发工程师",
                        "company":   "腾讯科技有限公司",
                        "salary":    "15k-25k",
                        "location":  "深圳",
                },
                "read_status":        "unread",
                "read_time":          nil,
                "send_status":        "sent",
                "send_time":          "2024-08-30T16:30:00Z",
                "expire_time":        "2024-09-30T16:30:00Z",
                "created_at":         "2024-08-30T16:30:00Z",
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "notification": notification,
                        "version":      "v2",
                        "database":     "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// MarkNotificationRead 标记通知已读
func (h *NotificationHandler) MarkNotificationRead(c *gin.Context) <span class="cov0" title="0">{
        notificationID := c.Param("id")
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">response := map[string]interface{}{
                "code":    200,
                "message": "Notification marked as read",
                "data": map[string]interface{}{
                        "notification_id": notificationID,
                        "user_id":         userID,
                        "read_time":       time.Now().Format("2006-01-02T15:04:05Z"),
                        "version":         "v2",
                        "database":        "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// MarkAllNotificationsRead 标记所有通知已读
func (h *NotificationHandler) MarkAllNotificationsRead(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">notificationType := c.Query("type")

        response := map[string]interface{}{
                "code":    200,
                "message": "All notifications marked as read",
                "data": map[string]interface{}{
                        "user_id":         userID,
                        "notification_type": notificationType,
                        "read_time":       time.Now().Format("2006-01-02T15:04:05Z"),
                        "affected_count":  3, // 标记为已读的通知数量
                        "version":         "v2",
                        "database":        "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetNotificationSettings 获取通知设置
func (h *NotificationHandler) GetNotificationSettings(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        // 模拟通知设置数据
        <span class="cov0" title="0">settings := map[string]interface{}{
                "user_id":                    userID,
                "email_notifications":        true,
                "sms_notifications":          true,
                "push_notifications":         true,
                "in_app_notifications":       true,
                "job_apply_notifications":    true,
                "resume_view_notifications":  true,
                "chat_notifications":         true,
                "system_notifications":       true,
                "points_notifications":       true,
                "quiet_hours_start":          "22:00:00",
                "quiet_hours_end":            "08:00:00",
                "created_at":                 "2024-08-30T10:00:00Z",
                "updated_at":                 "2024-08-30T16:00:00Z",
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "settings": settings,
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// UpdateNotificationSettings 更新通知设置
func (h *NotificationHandler) UpdateNotificationSettings(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">var request struct {
                EmailNotifications       *bool  `json:"email_notifications"`
                SmsNotifications         *bool  `json:"sms_notifications"`
                PushNotifications        *bool  `json:"push_notifications"`
                InAppNotifications       *bool  `json:"in_app_notifications"`
                JobApplyNotifications    *bool  `json:"job_apply_notifications"`
                ResumeViewNotifications  *bool  `json:"resume_view_notifications"`
                ChatNotifications        *bool  `json:"chat_notifications"`
                SystemNotifications      *bool  `json:"system_notifications"`
                PointsNotifications      *bool  `json:"points_notifications"`
                QuietHoursStart          string `json:"quiet_hours_start"`
                QuietHoursEnd            string `json:"quiet_hours_end"`
        }

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 模拟更新后的设置
        <span class="cov0" title="0">settings := map[string]interface{}{
                "user_id":                    userID,
                "email_notifications":        request.EmailNotifications != nil &amp;&amp; *request.EmailNotifications,
                "sms_notifications":          request.SmsNotifications != nil &amp;&amp; *request.SmsNotifications,
                "push_notifications":         request.PushNotifications != nil &amp;&amp; *request.PushNotifications,
                "in_app_notifications":       request.InAppNotifications != nil &amp;&amp; *request.InAppNotifications,
                "job_apply_notifications":    request.JobApplyNotifications != nil &amp;&amp; *request.JobApplyNotifications,
                "resume_view_notifications":  request.ResumeViewNotifications != nil &amp;&amp; *request.ResumeViewNotifications,
                "chat_notifications":         request.ChatNotifications != nil &amp;&amp; *request.ChatNotifications,
                "system_notifications":       request.SystemNotifications != nil &amp;&amp; *request.SystemNotifications,
                "points_notifications":       request.PointsNotifications != nil &amp;&amp; *request.PointsNotifications,
                "quiet_hours_start":          request.QuietHoursStart,
                "quiet_hours_end":            request.QuietHoursEnd,
                "updated_at":                 time.Now().Format("2006-01-02T15:04:05Z"),
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "Notification settings updated successfully",
                "data": map[string]interface{}{
                        "settings": settings,
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetNotificationTemplates 获取通知模板
func (h *NotificationHandler) GetNotificationTemplates(c *gin.Context) <span class="cov0" title="0">{
        // 模拟通知模板数据
        templates := []map[string]interface{}{
                {
                        "id":             1,
                        "template_code":  "JOB_APPLY_SUCCESS",
                        "template_name":  "职位申请成功",
                        "template_type":  "in_app",
                        "title":          "申请成功",
                        "content":        "您申请的职位\"{job_title}\"已成功提交，我们会尽快为您安排面试。",
                        "variables": map[string]interface{}{
                                "job_title": "职位名称",
                        },
                        "status":     "active",
                        "created_at": "2024-08-30T10:00:00Z",
                },
                {
                        "id":             2,
                        "template_code":  "RESUME_VIEWED",
                        "template_name":  "简历被查看",
                        "template_type":  "in_app",
                        "title":          "简历被查看",
                        "content":        "您的简历被\"{company_name}\"查看，请保持电话畅通。",
                        "variables": map[string]interface{}{
                                "company_name": "公司名称",
                        },
                        "status":     "active",
                        "created_at": "2024-08-30T10:00:00Z",
                },
                {
                        "id":             3,
                        "template_code":  "CHAT_MESSAGE",
                        "template_name":  "新消息提醒",
                        "template_type":  "in_app",
                        "title":          "新消息",
                        "content":        "您收到来自\"{sender_name}\"的新消息：{message_preview}",
                        "variables": map[string]interface{}{
                                "sender_name":     "发送者姓名",
                                "message_preview": "消息预览",
                        },
                        "status":     "active",
                        "created_at": "2024-08-30T10:00:00Z",
                },
                {
                        "id":             4,
                        "template_code":  "POINTS_EARNED",
                        "template_name":  "获得积分",
                        "template_type":  "in_app",
                        "title":          "获得积分",
                        "content":        "恭喜您获得{points}积分！{reason}",
                        "variables": map[string]interface{}{
                                "points": "积分数量",
                                "reason": "获得原因",
                        },
                        "status":     "active",
                        "created_at": "2024-08-30T10:00:00Z",
                },
                {
                        "id":             5,
                        "template_code":  "SYSTEM_ANNOUNCEMENT",
                        "template_name":  "系统公告",
                        "template_type":  "in_app",
                        "title":          "系统公告",
                        "content":        "{title}\n\n{content}",
                        "variables": map[string]interface{}{
                                "title":   "公告标题",
                                "content": "公告内容",
                        },
                        "status":     "active",
                        "created_at": "2024-08-30T10:00:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "templates": templates,
                        "total":     len(templates),
                        "version":   "v2",
                        "database":  "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// SendNotification 发送通知
func (h *NotificationHandler) SendNotification(c *gin.Context) <span class="cov0" title="0">{
        var request struct {
                UserID           string                 `json:"user_id" binding:"required"`
                NotificationType string                 `json:"notification_type" binding:"required"`
                Title            string                 `json:"title" binding:"required"`
                Content          string                 `json:"content" binding:"required"`
                Data             map[string]interface{} `json:"data"`
                TemplateCode     string                 `json:"template_code"`
                Channels         []string               `json:"channels"` // email, sms, push, in_app
        }

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        // 模拟发送通知
        <span class="cov0" title="0">notification := map[string]interface{}{
                "id":                 6,
                "user_id":            request.UserID,
                "notification_type":  request.NotificationType,
                "title":              request.Title,
                "content":            request.Content,
                "data":               request.Data,
                "template_code":      request.TemplateCode,
                "read_status":        "unread",
                "read_time":          nil,
                "send_status":        "sent",
                "send_time":          time.Now().Format("2006-01-02T15:04:05Z"),
                "expire_time":        time.Now().AddDate(0, 1, 0).Format("2006-01-02T15:04:05Z"), // 1个月后过期
                "created_at":         time.Now().Format("2006-01-02T15:04:05Z"),
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "Notification sent successfully",
                "data": map[string]interface{}{
                        "notification": notification,
                        "channels":     request.Channels,
                        "version":      "v2",
                        "database":     "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}
</pre>
		
		<pre class="file" id="file8" style="display: none">package handlers

import (
        "net/http"
        "strconv"
        "time"

        "github.com/gin-gonic/gin"
)

type PointsHandler struct{}

func NewPointsHandler() *PointsHandler <span class="cov0" title="0">{
        return &amp;PointsHandler{}
}</span>

// GetPointsBalance 获取积分余额
func (h *PointsHandler) GetPointsBalance(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        // 模拟积分账户数据
        <span class="cov0" title="0">account := map[string]interface{}{
                "user_id":             userID,
                "balance":             1250,
                "total_earned":        1500,
                "total_spent":         250,
                "level":               "silver",
                "level_points":        1250,
                "next_level_points":   2000,
                "last_activity_time":  "2024-08-30T16:00:00Z",
                "points_needed":       750,
                "level_progress":      62.5, // 百分比
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "account": account,
                        "version": "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetPointsRecords 获取积分记录
func (h *PointsHandler) GetPointsRecords(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))

        // 模拟积分记录数据
        records := []map[string]interface{}{
                {
                        "id":             1,
                        "user_id":        userID,
                        "rule_code":      "DAILY_CHECKIN",
                        "rule_name":      "每日签到",
                        "points":         10,
                        "balance_before": 1240,
                        "balance_after":  1250,
                        "record_type":    "earn",
                        "source_type":    "daily_checkin",
                        "description":    "每日签到获得积分",
                        "created_at":     "2024-08-30T08:00:00Z",
                },
                {
                        "id":             2,
                        "user_id":        userID,
                        "rule_code":      "JOB_APPLY",
                        "rule_name":      "投递简历",
                        "points":         5,
                        "balance_before": 1235,
                        "balance_after":  1240,
                        "record_type":    "earn",
                        "source_type":    "job_apply",
                        "description":    "投递简历获得积分",
                        "created_at":     "2024-08-30T10:30:00Z",
                },
                {
                        "id":             3,
                        "user_id":        userID,
                        "rule_code":      "RESUME_VIEW",
                        "rule_name":      "简历被查看",
                        "points":         2,
                        "balance_before": 1233,
                        "balance_after":  1235,
                        "record_type":    "earn",
                        "source_type":    "resume_view",
                        "description":    "简历被HR查看获得积分",
                        "created_at":     "2024-08-30T14:15:00Z",
                },
                {
                        "id":             4,
                        "user_id":        userID,
                        "rule_code":      "EXCHANGE_COUPON",
                        "rule_name":      "兑换优惠券",
                        "points":         -100,
                        "balance_before": 1333,
                        "balance_after":  1233,
                        "record_type":    "spend",
                        "source_type":    "exchange",
                        "description":    "兑换优惠券消耗积分",
                        "created_at":     "2024-08-29T16:20:00Z",
                },
                {
                        "id":             5,
                        "user_id":        userID,
                        "rule_code":      "COMPLETE_PROFILE",
                        "rule_name":      "完善资料",
                        "points":         20,
                        "balance_before": 1313,
                        "balance_after":  1333,
                        "record_type":    "earn",
                        "source_type":    "system",
                        "description":    "完善个人资料获得积分",
                        "created_at":     "2024-08-28T09:00:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "records": records,
                        "total":   len(records),
                        "page":    page,
                        "limit":   limit,
                        "version": "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetPointsRules 获取积分规则
func (h *PointsHandler) GetPointsRules(c *gin.Context) <span class="cov0" title="0">{
        // 模拟积分规则数据
        rules := []map[string]interface{}{
                {
                        "rule_code":    "DAILY_CHECKIN",
                        "rule_name":    "每日签到",
                        "rule_type":    "earn",
                        "points":       10,
                        "description":  "每日签到获得积分",
                        "daily_limit":  1,
                        "total_limit":  0,
                        "status":       "active",
                },
                {
                        "rule_code":    "JOB_APPLY",
                        "rule_name":    "投递简历",
                        "rule_type":    "earn",
                        "points":       5,
                        "description":  "投递简历获得积分",
                        "daily_limit":  10,
                        "total_limit":  0,
                        "status":       "active",
                },
                {
                        "rule_code":    "RESUME_VIEW",
                        "rule_name":    "简历被查看",
                        "rule_type":    "earn",
                        "points":       2,
                        "description":  "简历被HR查看获得积分",
                        "daily_limit":  0,
                        "total_limit":  0,
                        "status":       "active",
                },
                {
                        "rule_code":    "INVITE_FRIEND",
                        "rule_name":    "邀请好友",
                        "rule_type":    "earn",
                        "points":       50,
                        "description":  "邀请好友注册获得积分",
                        "daily_limit":  0,
                        "total_limit":  0,
                        "status":       "active",
                },
                {
                        "rule_code":    "COMPLETE_PROFILE",
                        "rule_name":    "完善资料",
                        "rule_type":    "earn",
                        "points":       20,
                        "description":  "完善个人资料获得积分",
                        "daily_limit":  0,
                        "total_limit":  1,
                        "status":       "active",
                },
                {
                        "rule_code":    "EXCHANGE_COUPON",
                        "rule_name":    "兑换优惠券",
                        "rule_type":    "spend",
                        "points":       -100,
                        "description":  "兑换优惠券消耗积分",
                        "daily_limit":  0,
                        "total_limit":  0,
                        "status":       "active",
                },
                {
                        "rule_code":    "EXCHANGE_VIP",
                        "rule_name":    "兑换VIP",
                        "rule_type":    "spend",
                        "points":       -500,
                        "description":  "兑换VIP会员消耗积分",
                        "daily_limit":  0,
                        "total_limit":  0,
                        "status":       "active",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "rules":   rules,
                        "total":   len(rules),
                        "version": "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)
}</span>

// ExchangePoints 积分兑换
func (h *PointsHandler) ExchangePoints(c *gin.Context) <span class="cov0" title="0">{
        var request struct {
                ItemType   string  `json:"item_type" binding:"required"`
                ItemName   string  `json:"item_name" binding:"required"`
                PointsCost int     `json:"points_cost" binding:"required"`
                ItemValue  float64 `json:"item_value"`
        }

        if err := c.ShouldBindJSON(&amp;request); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{
                        "code":    400,
                        "message": "Invalid request data",
                        "error":   err.Error(),
                })
                return
        }</span>

        <span class="cov0" title="0">userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        // 模拟兑换记录
        <span class="cov0" title="0">exchange := map[string]interface{}{
                "id":             1,
                "user_id":        userID,
                "exchange_code":  "EXCH_" + strconv.FormatInt(time.Now().Unix(), 10),
                "item_name":      request.ItemName,
                "item_type":      request.ItemType,
                "points_cost":    request.PointsCost,
                "item_value":     request.ItemValue,
                "status":         "completed",
                "exchange_time":  time.Now().Format("2006-01-02T15:04:05Z"),
                "expire_time":    time.Now().AddDate(0, 1, 0).Format("2006-01-02T15:04:05Z"), // 1个月后过期
                "description":    "积分兑换成功",
                "created_at":     time.Now().Format("2006-01-02T15:04:05Z"),
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "Exchange successful",
                "data": map[string]interface{}{
                        "exchange": exchange,
                        "version":  "v2",
                        "database": "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}

// GetExchangeHistory 获取兑换历史
func (h *PointsHandler) GetExchangeHistory(c *gin.Context) <span class="cov0" title="0">{
        userID := c.GetString("user_id")
        if userID == "" </span><span class="cov0" title="0">{
                userID = "1" // 默认用户ID
        }</span>

        <span class="cov0" title="0">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        limit, _ := strconv.Atoi(c.DefaultQuery("limit", "20"))

        // 模拟兑换历史数据
        exchanges := []map[string]interface{}{
                {
                        "id":             1,
                        "user_id":        userID,
                        "exchange_code":  "EXCH_1735567890",
                        "item_name":      "优惠券",
                        "item_type":      "coupon",
                        "points_cost":    100,
                        "item_value":     50.00,
                        "status":         "completed",
                        "exchange_time":  "2024-08-29T16:20:00Z",
                        "expire_time":    "2024-09-29T16:20:00Z",
                        "description":    "兑换优惠券",
                        "created_at":     "2024-08-29T16:20:00Z",
                },
                {
                        "id":             2,
                        "user_id":        userID,
                        "exchange_code":  "EXCH_1735471234",
                        "item_name":      "VIP会员",
                        "item_type":      "vip",
                        "points_cost":    500,
                        "item_value":     200.00,
                        "status":         "completed",
                        "exchange_time":  "2024-08-28T10:30:00Z",
                        "expire_time":    "2024-11-28T10:30:00Z",
                        "description":    "兑换VIP会员",
                        "created_at":     "2024-08-28T10:30:00Z",
                },
        }

        response := map[string]interface{}{
                "code":    200,
                "message": "success",
                "data": map[string]interface{}{
                        "exchanges": exchanges,
                        "total":     len(exchanges),
                        "page":      page,
                        "limit":     limit,
                        "version":   "v2",
                        "database":  "v2",
                },
        }

        c.JSON(http.StatusOK, response)</span>
}
</pre>
		
		<pre class="file" id="file9" style="display: none">package handlers

import (
        "fmt"
        "net/http"
        "strconv"
        "strings"
        "time"

        "jobfirst-basic/internal/models"

        "github.com/gin-gonic/gin"
        "github.com/google/uuid"
        "gorm.io/gorm"
)

// ResumeV3Handler V3.0简历处理器
type ResumeV3Handler struct {
        db *gorm.DB
}

// NewResumeV3Handler 创建V3.0简历处理器
func NewResumeV3Handler(db *gorm.DB) *ResumeV3Handler <span class="cov0" title="0">{
        return &amp;ResumeV3Handler{db: db}
}</span>

// GetResumes 获取简历列表
func (h *ResumeV3Handler) GetResumes(c *gin.Context) <span class="cov0" title="0">{
        userID := getUserIDFromContext(c)
        if userID == 0 </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{"code": 401, "message": "用户未认证"})
                return
        }</span>

        <span class="cov0" title="0">page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        size, _ := strconv.Atoi(c.DefaultQuery("size", "10"))
        status := c.Query("status")
        search := c.Query("search")

        offset := (page - 1) * size
        query := h.db.Model(&amp;models.ResumeV3{}).Where("user_id = ?", userID)

        if status != "" </span><span class="cov0" title="0">{
                query = query.Where("status = ?", status)
        }</span>

        <span class="cov0" title="0">if search != "" </span><span class="cov0" title="0">{
                query = query.Where("title LIKE ? OR summary LIKE ?", "%"+search+"%", "%"+search+"%")
        }</span>

        <span class="cov0" title="0">var resumes []models.ResumeV3
        var total int64

        query.Count(&amp;total)
        err := query.Preload("Template").
                Preload("Skills.Skill").
                Preload("WorkExperiences.Company").
                Preload("WorkExperiences.Position").
                Preload("Projects.Company").
                Preload("Educations").
                Preload("Certifications").
                Offset(offset).
                Limit(size).
                Order("created_at DESC").
                Find(&amp;resumes).Error

        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "获取简历列表失败", "error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data": models.ResumeListResponse{
                        Resumes: resumes,
                        Total:   total,
                        Page:    page,
                        Size:    size,
                },
        })</span>
}

// GetResume 获取简历详情
func (h *ResumeV3Handler) GetResume(c *gin.Context) <span class="cov0" title="0">{
        userID := getUserIDFromContext(c)
        if userID == 0 </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{"code": 401, "message": "用户未认证"})
                return
        }</span>

        <span class="cov0" title="0">resumeID, err := strconv.ParseUint(c.Param("id"), 10, 32)
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{"code": 400, "message": "无效的简历ID"})
                return
        }</span>

        <span class="cov0" title="0">var resume models.ResumeV3
        err = h.db.Preload("Template").
                Preload("Skills.Skill").
                Preload("WorkExperiences.Company").
                Preload("WorkExperiences.Position").
                Preload("Projects.Company").
                Preload("Educations").
                Preload("Certifications").
                Preload("Comments.User").
                Preload("Comments.Replies.User").
                Where("id = ? AND user_id = ?", resumeID, userID).
                First(&amp;resume).Error

        if err != nil </span><span class="cov0" title="0">{
                if err == gorm.ErrRecordNotFound </span><span class="cov0" title="0">{
                        c.JSON(http.StatusNotFound, gin.H{"code": 404, "message": "简历不存在"})
                }</span> else<span class="cov0" title="0"> {
                        c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "获取简历失败", "error": err.Error()})
                }</span>
                <span class="cov0" title="0">return</span>
        }

        // 增加浏览次数
        <span class="cov0" title="0">h.db.Model(&amp;resume).Update("view_count", gorm.Expr("view_count + 1"))

        c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data":    resume,
        })</span>
}

// CreateResume 创建简历
func (h *ResumeV3Handler) CreateResume(c *gin.Context) <span class="cov0" title="0">{
        userID := getUserIDFromContext(c)
        if userID == 0 </span><span class="cov0" title="0">{
                c.JSON(http.StatusUnauthorized, gin.H{"code": 401, "message": "用户未认证"})
                return
        }</span>

        <span class="cov0" title="0">var req models.CreateResumeRequest
        if err := c.ShouldBindJSON(&amp;req); err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusBadRequest, gin.H{"code": 400, "message": "请求参数错误", "error": err.Error()})
                return
        }</span>

        // 生成UUID和Slug
        <span class="cov0" title="0">uuid := generateUUID()
        slug := generateSlug(req.Title)

        resume := models.ResumeV3{
                UUID:       uuid,
                UserID:     userID,
                Title:      req.Title,
                Slug:       slug,
                TemplateID: req.TemplateID,
                Content:    req.Content,
                Status:     "draft",
                Visibility: req.Visibility,
                CanComment: true,
        }

        if req.Visibility == "" </span><span class="cov0" title="0">{
                resume.Visibility = "private"
        }</span>

        <span class="cov0" title="0">err := h.db.Create(&amp;resume).Error
        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "创建简历失败", "error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "简历创建成功",
                "data":    resume,
        })</span>
}

// GetSkills 获取技能列表
func (h *ResumeV3Handler) GetSkills(c *gin.Context) <span class="cov0" title="0">{
        page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))
        category := c.Query("category")
        search := c.Query("search")
        popular := c.Query("popular")

        offset := (page - 1) * size
        query := h.db.Model(&amp;models.Skill{})

        if category != "" </span><span class="cov0" title="0">{
                query = query.Where("category = ?", category)
        }</span>

        <span class="cov0" title="0">if search != "" </span><span class="cov0" title="0">{
                query = query.Where("name LIKE ?", "%"+search+"%")
        }</span>

        <span class="cov0" title="0">if popular == "true" </span><span class="cov0" title="0">{
                query = query.Where("is_popular = ?", true)
        }</span>

        <span class="cov0" title="0">var skills []models.Skill
        var total int64

        query.Count(&amp;total)
        err := query.Offset(offset).Limit(size).Order("search_count DESC, name ASC").Find(&amp;skills).Error

        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "获取技能列表失败", "error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data": models.SkillListResponse{
                        Skills: skills,
                        Total:  total,
                        Page:   page,
                        Size:   size,
                },
        })</span>
}

// GetCompanies 获取公司列表
func (h *ResumeV3Handler) GetCompanies(c *gin.Context) <span class="cov0" title="0">{
        page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))
        industry := c.Query("industry")
        search := c.Query("search")
        verified := c.Query("verified")

        offset := (page - 1) * size
        query := h.db.Model(&amp;models.Company{})

        if industry != "" </span><span class="cov0" title="0">{
                query = query.Where("industry = ?", industry)
        }</span>

        <span class="cov0" title="0">if search != "" </span><span class="cov0" title="0">{
                query = query.Where("name LIKE ?", "%"+search+"%")
        }</span>

        <span class="cov0" title="0">if verified == "true" </span><span class="cov0" title="0">{
                query = query.Where("is_verified = ?", true)
        }</span>

        <span class="cov0" title="0">var companies []models.Company
        var total int64

        query.Count(&amp;total)
        err := query.Offset(offset).Limit(size).Order("is_verified DESC, name ASC").Find(&amp;companies).Error

        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "获取公司列表失败", "error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data": models.CompanyListResponse{
                        Companies: companies,
                        Total:     total,
                        Page:      page,
                        Size:      size,
                },
        })</span>
}

// GetPositions 获取职位列表
func (h *ResumeV3Handler) GetPositions(c *gin.Context) <span class="cov0" title="0">{
        page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
        size, _ := strconv.Atoi(c.DefaultQuery("size", "20"))
        category := c.Query("category")
        level := c.Query("level")
        search := c.Query("search")

        offset := (page - 1) * size
        query := h.db.Model(&amp;models.Position{})

        if category != "" </span><span class="cov0" title="0">{
                query = query.Where("category = ?", category)
        }</span>

        <span class="cov0" title="0">if level != "" </span><span class="cov0" title="0">{
                query = query.Where("level = ?", level)
        }</span>

        <span class="cov0" title="0">if search != "" </span><span class="cov0" title="0">{
                query = query.Where("title LIKE ?", "%"+search+"%")
        }</span>

        <span class="cov0" title="0">var positions []models.Position
        var total int64

        query.Count(&amp;total)
        err := query.Offset(offset).Limit(size).Order("title ASC").Find(&amp;positions).Error

        if err != nil </span><span class="cov0" title="0">{
                c.JSON(http.StatusInternalServerError, gin.H{"code": 500, "message": "获取职位列表失败", "error": err.Error()})
                return
        }</span>

        <span class="cov0" title="0">c.JSON(http.StatusOK, gin.H{
                "code":    200,
                "message": "success",
                "data": models.PositionListResponse{
                        Positions: positions,
                        Total:     total,
                        Page:      page,
                        Size:      size,
                },
        })</span>
}

// ==================== 辅助函数 ====================

// getUserIDFromContext 从上下文获取用户ID
func getUserIDFromContext(c *gin.Context) uint <span class="cov0" title="0">{
        if userID, exists := c.Get("userID"); exists </span><span class="cov0" title="0">{
                if id, ok := userID.(uint); ok </span><span class="cov0" title="0">{
                        return id
                }</span>
        }
        <span class="cov0" title="0">return 0</span>
}

// generateUUID 生成UUID
func generateUUID() string <span class="cov0" title="0">{
        return uuid.New().String()
}</span>

// generateSlug 生成URL友好的slug
func generateSlug(title string) string <span class="cov0" title="0">{
        // 简单的slug生成逻辑
        slug := strings.ToLower(title)
        slug = strings.ReplaceAll(slug, " ", "-")
        slug = strings.ReplaceAll(slug, "，", "-")
        slug = strings.ReplaceAll(slug, "。", "-")
        slug = strings.ReplaceAll(slug, "、", "-")
        slug = strings.ReplaceAll(slug, "（", "-")
        slug = strings.ReplaceAll(slug, "）", "-")
        slug = strings.ReplaceAll(slug, "(", "-")
        slug = strings.ReplaceAll(slug, ")", "-")
        slug = strings.ReplaceAll(slug, "&amp;", "and")
        slug = strings.ReplaceAll(slug, "@", "at")
        slug = strings.ReplaceAll(slug, "#", "hash")
        slug = strings.ReplaceAll(slug, "%", "percent")
        slug = strings.ReplaceAll(slug, "+", "plus")
        slug = strings.ReplaceAll(slug, "=", "equals")
        slug = strings.ReplaceAll(slug, "?", "question")
        slug = strings.ReplaceAll(slug, "!", "exclamation")
        slug = strings.ReplaceAll(slug, "*", "star")
        slug = strings.ReplaceAll(slug, "^", "caret")
        slug = strings.ReplaceAll(slug, "~", "tilde")
        slug = strings.ReplaceAll(slug, "`", "backtick")
        slug = strings.ReplaceAll(slug, "|", "pipe")
        slug = strings.ReplaceAll(slug, "\\", "backslash")
        slug = strings.ReplaceAll(slug, "/", "slash")
        slug = strings.ReplaceAll(slug, ":", "colon")
        slug = strings.ReplaceAll(slug, ";", "semicolon")
        slug = strings.ReplaceAll(slug, "\"", "quote")
        slug = strings.ReplaceAll(slug, "'", "apostrophe")
        slug = strings.ReplaceAll(slug, "&lt;", "less")
        slug = strings.ReplaceAll(slug, "&gt;", "greater")
        slug = strings.ReplaceAll(slug, ",", "comma")
        slug = strings.ReplaceAll(slug, ".", "dot")

        // 移除连续的分隔符
        for strings.Contains(slug, "--") </span><span class="cov0" title="0">{
                slug = strings.ReplaceAll(slug, "--", "-")
        }</span>

        // 移除开头和结尾的分隔符
        <span class="cov0" title="0">slug = strings.Trim(slug, "-")

        // 如果为空，使用时间戳
        if slug == "" </span><span class="cov0" title="0">{
                slug = fmt.Sprintf("resume-%d", time.Now().Unix())
        }</span>

        <span class="cov0" title="0">return slug</span>
}
</pre>
		
		<pre class="file" id="file10" style="display: none">package models

import (
        "time"
)

// Job 职位模型
type Job struct {
        ID                 uint      `json:"id" gorm:"primaryKey"`
        CompanyID          uint      `json:"company_id" gorm:"not null"`
        CategoryID         uint      `json:"category_id" gorm:"not null"`
        Title              string    `json:"title" gorm:"not null;size:200"`
        JobType            string    `json:"job_type" gorm:"type:enum('full_time','part_time','internship','contract');default:'full_time'"`
        Location           string    `json:"location" gorm:"not null;size:200"`
        SalaryMin          int       `json:"salary_min"`
        SalaryMax          int       `json:"salary_max"`
        SalaryType         string    `json:"salary_type" gorm:"type:enum('monthly','yearly','hourly');default:'monthly'"`
        ExperienceRequired string    `json:"experience_required" gorm:"type:enum('entry','junior','mid','senior','expert')"`
        EducationRequired  string    `json:"education_required" gorm:"type:enum('high_school','college','bachelor','master','phd')"`
        Description        string    `json:"description" gorm:"type:text;not null"`
        Requirements       string    `json:"requirements" gorm:"type:text"`
        Benefits           string    `json:"benefits" gorm:"type:text"`
        Skills             string    `json:"skills" gorm:"type:json"`
        Tags               string    `json:"tags" gorm:"type:json"`
        Status             string    `json:"status" gorm:"type:enum('draft','published','paused','closed');default:'draft'"`
        Priority           int       `json:"priority" gorm:"default:0"`
        ViewCount          int       `json:"view_count" gorm:"default:0"`
        ApplicationCount   int       `json:"application_count" gorm:"default:0"`
        FavoriteCount      int       `json:"favorite_count" gorm:"default:0"`
        PublishAt          *time.Time `json:"publish_at"`
        ExpireAt           *time.Time `json:"expire_at"`
        CreatedAt          time.Time `json:"created_at" gorm:"autoCreateTime"`
        UpdatedAt          time.Time `json:"updated_at" gorm:"autoUpdateTime"`
        DeletedAt          *time.Time `json:"deleted_at" gorm:"index"`

        // 关联字段
        Company  Company  `json:"company" gorm:"foreignKey:CompanyID"`
        Category Category `json:"category" gorm:"foreignKey:CategoryID"`
}

// Company 企业模型
type Company struct {
        ID                uint      `json:"id" gorm:"primaryKey"`
        Name              string    `json:"name" gorm:"not null;size:200"`
        ShortName         string    `json:"short_name" gorm:"size:100"`
        LogoURL           string    `json:"logo_url" gorm:"size:500"`
        Industry          string    `json:"industry" gorm:"size:100"`
        CompanySize       string    `json:"company_size" gorm:"size:50"`
        Location          string    `json:"location" gorm:"size:200"`
        Website           string    `json:"website" gorm:"size:500"`
        Description       string    `json:"description" gorm:"type:text"`
        FoundedYear       int       `json:"founded_year"`
        BusinessLicense   string    `json:"business_license" gorm:"size:100"`
        Status            string    `json:"status" gorm:"type:enum('pending','verified','rejected');default:'pending'"`
        VerificationLevel string    `json:"verification_level" gorm:"type:enum('basic','premium','enterprise');default:'basic'"`
        JobCount          int       `json:"job_count" gorm:"default:0"`
        ViewCount         int       `json:"view_count" gorm:"default:0"`
        CreatedAt         time.Time `json:"created_at" gorm:"autoCreateTime"`
        UpdatedAt         time.Time `json:"updated_at" gorm:"autoUpdateTime"`
        DeletedAt         *time.Time `json:"deleted_at" gorm:"index"`
}

// Category 职位分类模型
type Category struct {
        ID          uint      `json:"id" gorm:"primaryKey"`
        Name        string    `json:"name" gorm:"not null;size:100"`
        ParentID    *uint     `json:"parent_id"`
        Level       int       `json:"level" gorm:"default:1"`
        SortOrder   int       `json:"sort_order" gorm:"default:0"`
        Icon        string    `json:"icon" gorm:"size:50"`
        Description string    `json:"description" gorm:"type:text"`
        JobCount    int       `json:"job_count" gorm:"default:0"`
        Status      string    `json:"status" gorm:"type:enum('active','inactive');default:'active'"`
        CreatedAt   time.Time `json:"created_at" gorm:"autoCreateTime"`
        UpdatedAt   time.Time `json:"updated_at" gorm:"autoUpdateTime"`
        DeletedAt   *time.Time `json:"deleted_at" gorm:"index"`
}

// TableName 指定表名
func (Job) TableName() string <span class="cov0" title="0">{
        return "jobs"
}</span>

func (Company) TableName() string <span class="cov0" title="0">{
        return "companies"
}</span>

func (Category) TableName() string <span class="cov0" title="0">{
        return "job_categories"
}</span>
</pre>
		
		<pre class="file" id="file11" style="display: none">package cache

import (
        "context"
        "log"
        "time"

        "github.com/redis/go-redis/v9"
        "jobfirst-basic/pkg/config"
)

func InitRedis(cfg config.RedisConfig) (*redis.Client, error) <span class="cov0" title="0">{
        client := redis.NewClient(&amp;redis.Options{
                Addr:         cfg.Host + ":" + cfg.Port,
                Password:     cfg.Password,
                DB:           cfg.DB,
                PoolSize:     cfg.PoolSize,
                MinIdleConns: cfg.MinIdleConns,
                MaxRetries:   cfg.MaxRetries,
                DialTimeout:  parseDuration(cfg.DialTimeout),
                ReadTimeout:  parseDuration(cfg.ReadTimeout),
                WriteTimeout: parseDuration(cfg.WriteTimeout),
        })

        // 测试连接
        ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
        defer cancel()

        if err := client.Ping(ctx).Err(); err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">log.Printf("Connected to Redis: %s:%s", cfg.Host, cfg.Port)
        return client, nil</span>
}

func CloseRedis(client *redis.Client) <span class="cov0" title="0">{
        if client != nil </span><span class="cov0" title="0">{
                if err := client.Close(); err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error closing Redis connection: %v", err)
                }</span> else<span class="cov0" title="0"> {
                        log.Println("Redis connection closed")
                }</span>
        }
}

func parseDuration(duration string) time.Duration <span class="cov0" title="0">{
        if parsed, err := time.ParseDuration(duration); err == nil </span><span class="cov0" title="0">{
                return parsed
        }</span>
        <span class="cov0" title="0">return 5 * time.Second</span> // 默认5秒
}
</pre>
		
		<pre class="file" id="file12" style="display: none">package config

import (
        "os"
        "strconv"
)

type Config struct {
        Environment string
        Version     string
        Mode        string
        Server      ServerConfig
        Database    DatabaseConfig
        Redis       RedisConfig
        JWT         JWTConfig
        Upload      UploadConfig
        Logging     LoggingConfig
        Cache       CacheConfig
        Security    SecurityConfig
        Points      PointsConfig
        AI          AIConfig
        Monitoring  MonitoringConfig
        Consul      ConsulConfig
}

type ServerConfig struct {
        Port            string
        Host            string
        ReadTimeout     string
        WriteTimeout    string
        MaxHeaderBytes  int
}

type DatabaseConfig struct {
        Driver          string
        Host            string
        Port            string
        Name            string
        User            string
        Password        string
        Charset         string
        ParseTime       bool
        Loc             string
        MaxOpenConns    int
        MaxIdleConns    int
        ConnMaxLifetime string
}

type RedisConfig struct {
        Host           string
        Port           string
        Password       string
        DB             int
        PoolSize       int
        MinIdleConns   int
        MaxRetries     int
        DialTimeout    string
        ReadTimeout    string
        WriteTimeout   string
}

type JWTConfig struct {
        Secret           string
        ExpiresIn        string
        RefreshExpiresIn string
        Issuer           string
}

type UploadConfig struct {
        MaxSize      int
        AllowedTypes []string
        UploadDir    string
        TempDir      string
}

type LoggingConfig struct {
        Level      string
        Format     string
        Output     string
        File       string
        MaxSize    int
        MaxAge     int
        MaxBackups int
}

type CacheConfig struct {
        DefaultTTL        string
        UserSessionTTL    string
        ResumeDataTTL     string
        TemplateDataTTL   string
}

type SecurityConfig struct {
        BcryptCost    int
        RateLimit     int
        RateLimitWindow string
        CORSOrigins   []string
        CORSMethods   []string
        CORSHeaders   []string
}

type PointsConfig struct {
        DefaultBalance      int
        ResumeCreateReward  int
        ResumeShareReward   int
        TemplateUseCost     int
        FileUploadCost      int
}

type AIConfig struct {
        Enabled     bool
        ServiceURL  string
        APIKey      string
        Timeout     string
        MaxRetries  int
}

type MonitoringConfig struct {
        Enabled              bool
        MetricsPort          string
        HealthCheckInterval  string
        PrometheusEnabled    bool
}

type ConsulConfig struct {
        Enabled              bool
        Host                 string
        Port                 string
        Scheme               string
        Datacenter           string
        Token                string
        ServiceName          string
        ServiceID            string
        ServiceTags          []string
        HealthCheckURL       string
        HealthCheckInterval  string
        HealthCheckTimeout   string
        DeregisterAfter      string
}

func Load() *Config <span class="cov0" title="0">{
        return &amp;Config{
                Environment: getEnv("ENVIRONMENT", "development"),
                Version:     getEnv("VERSION", "1.0.0"),
                Mode:        getEnv("MODE", "basic"),
                Server: ServerConfig{
                        Port:           getEnv("SERVER_PORT", "8080"),
                        Host:           getEnv("SERVER_HOST", "0.0.0.0"),
                        ReadTimeout:    getEnv("SERVER_READ_TIMEOUT", "30s"),
                        WriteTimeout:   getEnv("SERVER_WRITE_TIMEOUT", "30s"),
                        MaxHeaderBytes: getEnvAsInt("SERVER_MAX_HEADER_BYTES", 1048576),
                },
                Database: DatabaseConfig{
                        Driver:          getEnv("DB_DRIVER", "mysql"),
                        Host:            getEnv("DB_HOST", "localhost"),
                        Port:            getEnv("DB_PORT", "3306"),
                        Name:            getEnv("DB_NAME", "jobfirst"),
                        User:            getEnv("DB_USER", "root"),
                        Password:        getEnv("DB_PASSWORD", ""),
                        Charset:         getEnv("DB_CHARSET", "utf8mb4"),
                        ParseTime:       getEnvAsBool("DB_PARSE_TIME", true),
                        Loc:             getEnv("DB_LOC", "Local"),
                        MaxOpenConns:    getEnvAsInt("DB_MAX_OPEN_CONNS", 100),
                        MaxIdleConns:    getEnvAsInt("DB_MAX_IDLE_CONNS", 10),
                        ConnMaxLifetime: getEnv("DB_CONN_MAX_LIFETIME", "3600s"),
                },
                Redis: RedisConfig{
                        Host:         getEnv("REDIS_HOST", "localhost"),
                        Port:         getEnv("REDIS_PORT", "6379"),
                        Password:     getEnv("REDIS_PASSWORD", ""),
                        DB:           getEnvAsInt("REDIS_DB", 0),
                        PoolSize:     getEnvAsInt("REDIS_POOL_SIZE", 10),
                        MinIdleConns: getEnvAsInt("REDIS_MIN_IDLE_CONNS", 5),
                        MaxRetries:   getEnvAsInt("REDIS_MAX_RETRIES", 3),
                        DialTimeout:  getEnv("REDIS_DIAL_TIMEOUT", "5s"),
                        ReadTimeout:  getEnv("REDIS_READ_TIMEOUT", "3s"),
                        WriteTimeout: getEnv("REDIS_WRITE_TIMEOUT", "3s"),
                },
                JWT: JWTConfig{
                        Secret:           getEnv("JWT_SECRET", "jobfirst-basic-secret-key-2024"),
                        ExpiresIn:        getEnv("JWT_EXPIRES_IN", "24h"),
                        RefreshExpiresIn: getEnv("JWT_REFRESH_EXPIRES_IN", "168h"),
                        Issuer:           getEnv("JWT_ISSUER", "jobfirst-basic"),
                },
                Upload: UploadConfig{
                        MaxSize:      getEnvAsInt("UPLOAD_MAX_SIZE", 10485760),
                        AllowedTypes: []string{"pdf", "doc", "docx", "jpg", "jpeg", "png"},
                        UploadDir:    getEnv("UPLOAD_DIR", "./uploads"),
                        TempDir:      getEnv("TEMP_DIR", "./temp"),
                },
                Logging: LoggingConfig{
                        Level:      getEnv("LOGGING_LEVEL", "info"),
                        Format:     getEnv("LOGGING_FORMAT", "json"),
                        Output:     getEnv("LOGGING_OUTPUT", "stdout"),
                        File:       getEnv("LOGGING_FILE", "./logs/basic-server.log"),
                        MaxSize:    getEnvAsInt("LOGGING_MAX_SIZE", 100),
                        MaxAge:     getEnvAsInt("LOGGING_MAX_AGE", 30),
                        MaxBackups: getEnvAsInt("LOGGING_MAX_BACKUPS", 10),
                },
                Cache: CacheConfig{
                        DefaultTTL:      getEnv("CACHE_DEFAULT_TTL", "3600s"),
                        UserSessionTTL:  getEnv("CACHE_USER_SESSION_TTL", "7200s"),
                        ResumeDataTTL:   getEnv("CACHE_RESUME_DATA_TTL", "1800s"),
                        TemplateDataTTL: getEnv("CACHE_TEMPLATE_DATA_TTL", "7200s"),
                },
                Security: SecurityConfig{
                        BcryptCost:      getEnvAsInt("SECURITY_BCRYPT_COST", 12),
                        RateLimit:       getEnvAsInt("SECURITY_RATE_LIMIT", 100),
                        RateLimitWindow: getEnv("SECURITY_RATE_LIMIT_WINDOW", "1m"),
                        CORSOrigins:     []string{"*"},
                        CORSMethods:     []string{"GET", "POST", "PUT", "DELETE", "OPTIONS"},
                        CORSHeaders:     []string{"Origin", "Content-Type", "Accept", "Authorization"},
                },
                Points: PointsConfig{
                        DefaultBalance:     getEnvAsInt("POINTS_DEFAULT_BALANCE", 100),
                        ResumeCreateReward: getEnvAsInt("POINTS_RESUME_CREATE_REWARD", 10),
                        ResumeShareReward:  getEnvAsInt("POINTS_RESUME_SHARE_REWARD", 5),
                        TemplateUseCost:    getEnvAsInt("POINTS_TEMPLATE_USE_COST", 2),
                        FileUploadCost:     getEnvAsInt("POINTS_FILE_UPLOAD_COST", 1),
                },
                AI: AIConfig{
                        Enabled:    getEnvAsBool("AI_ENABLED", true),
                        ServiceURL: getEnv("AI_SERVICE_URL", "http://localhost:8206"),
                        APIKey:     getEnv("AI_API_KEY", ""),
                        Timeout:    getEnv("AI_TIMEOUT", "30s"),
                        MaxRetries: getEnvAsInt("AI_MAX_RETRIES", 3),
                },
                Monitoring: MonitoringConfig{
                        Enabled:             getEnvAsBool("MONITORING_ENABLED", true),
                        MetricsPort:         getEnv("MONITORING_METRICS_PORT", "9090"),
                        HealthCheckInterval: getEnv("MONITORING_HEALTH_CHECK_INTERVAL", "30s"),
                        PrometheusEnabled:   getEnvAsBool("MONITORING_PROMETHEUS_ENABLED", true),
                },
                Consul: ConsulConfig{
                        Enabled:             getEnvAsBool("CONSUL_ENABLED", true),
                        Host:                getEnv("CONSUL_HOST", "localhost"),
                        Port:                getEnv("CONSUL_PORT", "8500"),
                        Scheme:              getEnv("CONSUL_SCHEME", "http"),
                        Datacenter:          getEnv("CONSUL_DATACENTER", "dc1"),
                        Token:               getEnv("CONSUL_TOKEN", ""),
                        ServiceName:         getEnv("CONSUL_SERVICE_NAME", "basic-server"),
                        ServiceID:           getEnv("CONSUL_SERVICE_ID", "basic-server-1"),
                        ServiceTags:         []string{"api", "gateway", "basic"},
                        HealthCheckURL:      getEnv("CONSUL_HEALTH_CHECK_URL", "/health"),
                        HealthCheckInterval: getEnv("CONSUL_HEALTH_CHECK_INTERVAL", "10s"),
                        HealthCheckTimeout:  getEnv("CONSUL_HEALTH_CHECK_TIMEOUT", "5s"),
                        DeregisterAfter:     getEnv("CONSUL_DEREGISTER_AFTER", "30s"),
                },
        }
}</span>

func getEnv(key, defaultValue string) string <span class="cov0" title="0">{
        if value := os.Getenv(key); value != "" </span><span class="cov0" title="0">{
                return value
        }</span>
        <span class="cov0" title="0">return defaultValue</span>
}

func getEnvAsInt(key string, defaultValue int) int <span class="cov0" title="0">{
        if value := os.Getenv(key); value != "" </span><span class="cov0" title="0">{
                if intValue, err := strconv.Atoi(value); err == nil </span><span class="cov0" title="0">{
                        return intValue
                }</span>
        }
        <span class="cov0" title="0">return defaultValue</span>
}

func getEnvAsBool(key string, defaultValue bool) bool <span class="cov0" title="0">{
        if value := os.Getenv(key); value != "" </span><span class="cov0" title="0">{
                if boolValue, err := strconv.ParseBool(value); err == nil </span><span class="cov0" title="0">{
                        return boolValue
                }</span>
        }
        <span class="cov0" title="0">return defaultValue</span>
}
</pre>
		
		<pre class="file" id="file13" style="display: none">package consul

import (
        "context"
        "fmt"
        "log"
        "net/http"
        "time"

        "jobfirst-basic/pkg/config"

        "github.com/hashicorp/consul/api"
)

// ServiceManager Consul服务管理器
type ServiceManager struct {
        client   *api.Client
        config   *config.ConsulConfig
        services map[string]*api.AgentServiceRegistration
        ctx      context.Context
        cancel   context.CancelFunc
}

// NewServiceManager 创建新的服务管理器
func NewServiceManager(cfg *config.ConsulConfig) (*ServiceManager, error) <span class="cov0" title="0">{
        consulConfig := &amp;api.Config{
                Address:    fmt.Sprintf("%s:%s", cfg.Host, cfg.Port),
                Scheme:     cfg.Scheme,
                Datacenter: cfg.Datacenter,
                Token:      cfg.Token,
        }

        client, err := api.NewClient(consulConfig)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to create consul client: %v", err)
        }</span>

        <span class="cov0" title="0">ctx, cancel := context.WithCancel(context.Background())

        manager := &amp;ServiceManager{
                client:   client,
                config:   cfg,
                services: make(map[string]*api.AgentServiceRegistration),
                ctx:      ctx,
                cancel:   cancel,
        }

        return manager, nil</span>
}

// RegisterService 注册服务到Consul
func (m *ServiceManager) RegisterService(serviceName, serviceID, address string, port int, tags []string) error <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                log.Printf("Consul is disabled, skipping service registration for %s", serviceName)
                return nil
        }</span>

        // 构建健康检查URL
        <span class="cov0" title="0">healthCheckURL := fmt.Sprintf("http://%s:%d%s", address, port, m.config.HealthCheckURL)

        // 解析健康检查间隔和超时（用于日志记录）
        _, err := time.ParseDuration(m.config.HealthCheckInterval)
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("Invalid health check interval: %s, using default", m.config.HealthCheckInterval)
        }</span>

        <span class="cov0" title="0">_, err = time.ParseDuration(m.config.HealthCheckTimeout)
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("Invalid health check timeout: %s, using default", m.config.HealthCheckTimeout)
        }</span>

        <span class="cov0" title="0">_, err = time.ParseDuration(m.config.DeregisterAfter)
        if err != nil </span><span class="cov0" title="0">{
                log.Printf("Invalid deregister after: %s, using default", m.config.DeregisterAfter)
        }</span>

        // 创建服务注册信息
        <span class="cov0" title="0">registration := &amp;api.AgentServiceRegistration{
                ID:      serviceID,
                Name:    serviceName,
                Address: address,
                Port:    port,
                Tags:    tags,
                Check: &amp;api.AgentServiceCheck{
                        HTTP:                           healthCheckURL,
                        Interval:                       m.config.HealthCheckInterval,
                        Timeout:                        m.config.HealthCheckTimeout,
                        DeregisterCriticalServiceAfter: m.config.DeregisterAfter,
                },
        }

        // 注册服务
        err = m.client.Agent().ServiceRegister(registration)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to register service %s: %v", serviceName, err)
        }</span>

        // 保存到本地缓存
        <span class="cov0" title="0">m.services[serviceID] = registration

        log.Printf("Service %s registered successfully to Consul", serviceName)
        return nil</span>
}

// DeregisterService 从Consul注销服务
func (m *ServiceManager) DeregisterService(serviceID string) error <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                log.Printf("Consul is disabled, skipping service deregistration for %s", serviceID)
                return nil
        }</span>

        <span class="cov0" title="0">err := m.client.Agent().ServiceDeregister(serviceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to deregister service %s: %v", serviceID, err)
        }</span>

        // 从本地缓存移除
        <span class="cov0" title="0">delete(m.services, serviceID)

        log.Printf("Service %s deregistered successfully from Consul", serviceID)
        return nil</span>
}

// DiscoverService 发现服务
func (m *ServiceManager) DiscoverService(serviceName string) ([]*api.ServiceEntry, error) <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("consul is disabled")
        }</span>

        <span class="cov0" title="0">services, _, err := m.client.Health().Service(serviceName, "", true, nil)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to discover service %s: %v", serviceName, err)
        }</span>

        <span class="cov0" title="0">return services, nil</span>
}

// GetServiceHealth 获取服务健康状态
func (m *ServiceManager) GetServiceHealth(serviceName string) (string, error) <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                return "unknown", nil
        }</span>

        <span class="cov0" title="0">services, _, err := m.client.Health().Service(serviceName, "", true, nil)
        if err != nil </span><span class="cov0" title="0">{
                return "error", err
        }</span>

        <span class="cov0" title="0">if len(services) == 0 </span><span class="cov0" title="0">{
                return "not_found", nil
        }</span>

        // 返回第一个服务的健康状态
        <span class="cov0" title="0">return services[0].Checks.AggregatedStatus(), nil</span>
}

// ListServices 列出所有注册的服务
func (m *ServiceManager) ListServices() (map[string]*api.AgentService, error) <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("consul is disabled")
        }</span>

        <span class="cov0" title="0">services, err := m.client.Agent().Services()
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to list services: %v", err)
        }</span>

        <span class="cov0" title="0">return services, nil</span>
}

// HealthCheck 执行健康检查
func (m *ServiceManager) HealthCheck(serviceID string) error <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">service, exists := m.services[serviceID]
        if !exists </span><span class="cov0" title="0">{
                return fmt.Errorf("service %s not found in local cache", serviceID)
        }</span>

        // 构建健康检查URL
        <span class="cov0" title="0">healthCheckURL := fmt.Sprintf("http://%s:%d%s", service.Address, service.Port, m.config.HealthCheckURL)

        // 执行HTTP健康检查
        ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
        defer cancel()

        req, err := http.NewRequestWithContext(ctx, "GET", healthCheckURL, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to create health check request: %v", err)
        }</span>

        <span class="cov0" title="0">resp, err := http.DefaultClient.Do(req)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("health check failed for %s: %v", serviceID, err)
        }</span>
        <span class="cov0" title="0">defer resp.Body.Close()

        if resp.StatusCode != http.StatusOK </span><span class="cov0" title="0">{
                return fmt.Errorf("health check failed for %s: status %d", serviceID, resp.StatusCode)
        }</span>

        <span class="cov0" title="0">log.Printf("Health check passed for service %s", serviceID)
        return nil</span>
}

// StartHealthCheckLoop 启动健康检查循环
func (m *ServiceManager) StartHealthCheckLoop() <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                log.Println("Consul is disabled, skipping health check loop")
                return
        }</span>

        <span class="cov0" title="0">interval, err := time.ParseDuration(m.config.HealthCheckInterval)
        if err != nil </span><span class="cov0" title="0">{
                interval = 10 * time.Second
        }</span>

        <span class="cov0" title="0">ticker := time.NewTicker(interval)
        defer ticker.Stop()

        log.Printf("Starting health check loop with interval %v", interval)

        for </span><span class="cov0" title="0">{
                select </span>{
                case &lt;-m.ctx.Done():<span class="cov0" title="0">
                        log.Println("Health check loop stopped")
                        return</span>
                case &lt;-ticker.C:<span class="cov0" title="0">
                        // 对所有注册的服务执行健康检查
                        for serviceID := range m.services </span><span class="cov0" title="0">{
                                go func(id string) </span><span class="cov0" title="0">{
                                        if err := m.HealthCheck(id); err != nil </span><span class="cov0" title="0">{
                                                log.Printf("Health check failed for service %s: %v", id, err)
                                        }</span>
                                }(serviceID)
                        }
                }
        }
}

// Close 关闭服务管理器
func (m *ServiceManager) Close() error <span class="cov0" title="0">{
        m.cancel()

        // 注销所有服务
        for serviceID := range m.services </span><span class="cov0" title="0">{
                if err := m.DeregisterService(serviceID); err != nil </span><span class="cov0" title="0">{
                        log.Printf("Failed to deregister service %s: %v", serviceID, err)
                }</span>
        }

        <span class="cov0" title="0">return nil</span>
}

// IsHealthy 检查Consul连接是否健康
func (m *ServiceManager) IsHealthy() bool <span class="cov0" title="0">{
        if !m.config.Enabled </span><span class="cov0" title="0">{
                return false
        }</span>

        <span class="cov0" title="0">leader, err := m.client.Status().Leader()
        if err != nil </span><span class="cov0" title="0">{
                return false
        }</span>

        <span class="cov0" title="0">return leader != ""</span>
}

// GetConsulStatus 获取Consul状态信息
func (m *ServiceManager) GetConsulStatus() map[string]interface{} <span class="cov0" title="0">{
        status := map[string]interface{}{
                "enabled": m.config.Enabled,
                "healthy": m.IsHealthy(),
        }

        if m.config.Enabled </span><span class="cov0" title="0">{
                leader, err := m.client.Status().Leader()
                if err == nil </span><span class="cov0" title="0">{
                        status["leader"] = leader
                }</span>

                <span class="cov0" title="0">peers, err := m.client.Status().Peers()
                if err == nil </span><span class="cov0" title="0">{
                        status["peers"] = peers
                }</span>

                <span class="cov0" title="0">services, err := m.ListServices()
                if err == nil </span><span class="cov0" title="0">{
                        status["registered_services"] = len(services)
                }</span>
        }

        <span class="cov0" title="0">return status</span>
}
</pre>
		
		<pre class="file" id="file14" style="display: none">package consul

import (
        "fmt"
        "log"
        "sync"
        "time"

        "jobfirst-basic/pkg/config"
)

// MicroserviceInfo 微服务信息
type MicroserviceInfo struct {
        Name        string            `json:"name"`
        ID          string            `json:"id"`
        Address     string            `json:"address"`
        Port        int               `json:"port"`
        Tags        []string          `json:"tags"`
        HealthCheck string            `json:"health_check"`
        Status      string            `json:"status"`
        LastSeen    time.Time         `json:"last_seen"`
        Metadata    map[string]string `json:"metadata"`
}

// MicroserviceRegistry 微服务注册器
type MicroserviceRegistry struct {
        consulManager *ServiceManager
        services      map[string]*MicroserviceInfo
        mu            sync.RWMutex
}

// NewMicroserviceRegistry 创建微服务注册器
func NewMicroserviceRegistry(consulManager *ServiceManager) *MicroserviceRegistry <span class="cov0" title="0">{
        return &amp;MicroserviceRegistry{
                consulManager: consulManager,
                services:      make(map[string]*MicroserviceInfo),
        }
}</span>

// RegisterMicroservice 注册微服务
func (r *MicroserviceRegistry) RegisterMicroservice(service *MicroserviceInfo) error <span class="cov0" title="0">{
        r.mu.Lock()
        defer r.mu.Unlock()

        // 注册到Consul
        err := r.consulManager.RegisterService(
                service.Name,
                service.ID,
                service.Address,
                service.Port,
                service.Tags,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to register microservice %s: %v", service.Name, err)
        }</span>

        // 保存到本地缓存
        <span class="cov0" title="0">service.LastSeen = time.Now()
        service.Status = "registered"
        r.services[service.ID] = service

        log.Printf("Microservice %s registered successfully", service.Name)
        return nil</span>
}

// DeregisterMicroservice 注销微服务
func (r *MicroserviceRegistry) DeregisterMicroservice(serviceID string) error <span class="cov0" title="0">{
        r.mu.Lock()
        defer r.mu.Unlock()

        // 从Consul注销
        err := r.consulManager.DeregisterService(serviceID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("failed to deregister microservice %s: %v", serviceID, err)
        }</span>

        // 从本地缓存移除
        <span class="cov0" title="0">delete(r.services, serviceID)

        log.Printf("Microservice %s deregistered successfully", serviceID)
        return nil</span>
}

// GetMicroservice 获取微服务信息
func (r *MicroserviceRegistry) GetMicroservice(serviceID string) (*MicroserviceInfo, error) <span class="cov0" title="0">{
        r.mu.RLock()
        defer r.mu.RUnlock()

        service, exists := r.services[serviceID]
        if !exists </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("microservice not found: %s", serviceID)
        }</span>

        <span class="cov0" title="0">return service, nil</span>
}

// ListMicroservices 列出所有微服务
func (r *MicroserviceRegistry) ListMicroservices() []*MicroserviceInfo <span class="cov0" title="0">{
        r.mu.RLock()
        defer r.mu.RUnlock()

        var services []*MicroserviceInfo
        for _, service := range r.services </span><span class="cov0" title="0">{
                services = append(services, service)
        }</span>

        <span class="cov0" title="0">return services</span>
}

// UpdateMicroserviceStatus 更新微服务状态
func (r *MicroserviceRegistry) UpdateMicroserviceStatus(serviceID, status string) error <span class="cov0" title="0">{
        r.mu.Lock()
        defer r.mu.Unlock()

        service, exists := r.services[serviceID]
        if !exists </span><span class="cov0" title="0">{
                return fmt.Errorf("microservice not found: %s", serviceID)
        }</span>

        <span class="cov0" title="0">service.Status = status
        service.LastSeen = time.Now()

        log.Printf("Microservice %s status updated to: %s", serviceID, status)
        return nil</span>
}

// HealthCheckAll 对所有微服务执行健康检查
func (r *MicroserviceRegistry) HealthCheckAll() map[string]string <span class="cov0" title="0">{
        r.mu.RLock()
        defer r.mu.RUnlock()

        results := make(map[string]string)

        for serviceID, service := range r.services </span><span class="cov0" title="0">{
                // 执行健康检查
                err := r.consulManager.HealthCheck(serviceID)
                if err != nil </span><span class="cov0" title="0">{
                        results[serviceID] = "unhealthy"
                        log.Printf("Health check failed for microservice %s: %v", serviceID, err)
                }</span> else<span class="cov0" title="0"> {
                        results[serviceID] = "healthy"
                        service.LastSeen = time.Now()
                }</span>
        }

        <span class="cov0" title="0">return results</span>
}

// GetServiceDiscoveryInfo 获取服务发现信息
func (r *MicroserviceRegistry) GetServiceDiscoveryInfo() map[string]interface{} <span class="cov0" title="0">{
        r.mu.RLock()
        defer r.mu.RUnlock()

        info := map[string]interface{}{
                "total_services": len(r.services),
                "consul_status":  r.consulManager.GetConsulStatus(),
                "services":       r.services,
        }

        return info
}</span>

// StartPeriodicHealthCheck 启动定期健康检查
func (r *MicroserviceRegistry) StartPeriodicHealthCheck(interval time.Duration) <span class="cov0" title="0">{
        go func() </span><span class="cov0" title="0">{
                ticker := time.NewTicker(interval)
                defer ticker.Stop()

                log.Printf("Starting periodic health check with interval %v", interval)

                for </span><span class="cov0" title="0">{
                        select </span>{
                        case &lt;-ticker.C:<span class="cov0" title="0">
                                results := r.HealthCheckAll()
                                log.Printf("Health check results: %v", results)</span>
                        }
                }
        }()
}

// RegisterDefaultServices 注册默认的微服务
func (r *MicroserviceRegistry) RegisterDefaultServices(cfg *config.Config) error <span class="cov0" title="0">{
        // 注册主后端服务（API网关）
        basicServerService := &amp;MicroserviceInfo{
                Name:        "basic-server",
                ID:          "basic-server-1",
                Address:     "localhost",
                Port:        8080,
                Tags:        []string{"api-gateway", "auth", "user", "resume", "job", "banner", "statistics"},
                HealthCheck: "/health",
                Status:      "pending",
                Metadata: map[string]string{
                        "version":     "1.0.0",
                        "environment": cfg.Environment,
                        "mode":        cfg.Mode,
                        "apis":        "auth/login,auth/register,auth/wechat-login,user/sendCode,user/wechatRegister,banner/list,job/recommend,statistics/market,users,resumes,jobs,points",
                },
        }

        if err := r.RegisterMicroservice(basicServerService); err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to register basic-server service: %v", err)
        }</span>

        // 注册用户服务
        <span class="cov0" title="0">userService := &amp;MicroserviceInfo{
                Name:        "user-service",
                ID:          "user-service-1",
                Address:     "localhost",
                Port:        8081,
                Tags:        []string{"user", "auth", "profile", "chat", "points", "notifications"},
                HealthCheck: "/health",
                Status:      "pending",
                Metadata: map[string]string{
                        "version":     "1.0.0",
                        "environment": cfg.Environment,
                        "mode":        cfg.Mode,
                        "apis":        "auth/login,auth/register,auth/check,user/profile,user/logout,jobs,companies,banners,chat,points,notifications",
                },
        }

        if err := r.RegisterMicroservice(userService); err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to register user service: %v", err)
        }</span>

        // 注册简历服务
        <span class="cov0" title="0">resumeService := &amp;MicroserviceInfo{
                Name:        "resume-service",
                ID:          "resume-service-1",
                Address:     "localhost",
                Port:        8082,
                Tags:        []string{"resume", "template", "ai", "upload", "preview"},
                HealthCheck: "/health",
                Status:      "pending",
                Metadata: map[string]string{
                        "version":     "1.0.0",
                        "environment": cfg.Environment,
                        "mode":        cfg.Mode,
                        "apis":        "resume/templates,resume/banners,resume/list,resume/detail,resume/create,resume/update,resume/delete,resume/upload,resume/preview,resume/auth,resume/blacklist",
                },
        }

        if err := r.RegisterMicroservice(resumeService); err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to register resume service: %v", err)
        }</span>

        // 注册AI服务
        <span class="cov0" title="0">aiService := &amp;MicroserviceInfo{
                Name:        "ai-service",
                ID:          "ai-service-1",
                Address:     "localhost",
                Port:        8206,
                Tags:        []string{"ai", "ml", "vector", "analysis", "chat"},
                HealthCheck: "/health",
                Status:      "pending",
                Metadata: map[string]string{
                        "version":     "1.0.0",
                        "environment": cfg.Environment,
                        "mode":        cfg.Mode,
                        "apis":        "analyze/resume,vectors,vectors/search,chat,health",
                },
        }

        if err := r.RegisterMicroservice(aiService); err != nil </span><span class="cov0" title="0">{
                log.Printf("Warning: Failed to register AI service: %v", err)
        }</span>

        <span class="cov0" title="0">log.Printf("Default microservices registration completed")
        return nil</span>
}

// DiscoverService 发现服务
func (r *MicroserviceRegistry) DiscoverService(serviceName string) ([]*MicroserviceInfo, error) <span class="cov0" title="0">{
        // 从Consul发现服务
        services, err := r.consulManager.DiscoverService(serviceName)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">var microservices []*MicroserviceInfo
        for _, service := range services </span><span class="cov0" title="0">{
                microservice := &amp;MicroserviceInfo{
                        Name:        service.Service.Service,
                        ID:          service.Service.ID,
                        Address:     service.Service.Address,
                        Port:        service.Service.Port,
                        Tags:        service.Service.Tags,
                        HealthCheck: service.Service.Address,
                        Status:      service.Checks.AggregatedStatus(),
                        LastSeen:    time.Now(),
                }
                microservices = append(microservices, microservice)
        }</span>

        <span class="cov0" title="0">return microservices, nil</span>
}

// GetServiceEndpoints 获取服务端点信息
func (r *MicroserviceRegistry) GetServiceEndpoints() map[string]string <span class="cov0" title="0">{
        r.mu.RLock()
        defer r.mu.RUnlock()

        endpoints := make(map[string]string)
        for _, service := range r.services </span><span class="cov0" title="0">{
                endpoints[service.Name] = fmt.Sprintf("http://%s:%d", service.Address, service.Port)
        }</span>

        <span class="cov0" title="0">return endpoints</span>
}
</pre>
		
		<pre class="file" id="file15" style="display: none">package database

import (
        "database/sql"
        "fmt"
        "log"
        "time"

        _ "github.com/go-sql-driver/mysql"
        "jobfirst-basic/pkg/config"
)

func InitMySQL(cfg config.DatabaseConfig) (*sql.DB, error) <span class="cov0" title="0">{
        dsn := fmt.Sprintf("%s:%s@tcp(%s:%s)/%s?charset=%s&amp;parseTime=%t&amp;loc=%s",
                cfg.User,
                cfg.Password,
                cfg.Host,
                cfg.Port,
                cfg.Name,
                cfg.Charset,
                cfg.ParseTime,
                cfg.Loc,
        )

        db, err := sql.Open("mysql", dsn)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to open database: %v", err)
        }</span>

        // 设置连接池参数
        <span class="cov0" title="0">db.SetMaxOpenConns(cfg.MaxOpenConns)
        db.SetMaxIdleConns(cfg.MaxIdleConns)
        
        // 解析连接最大生命周期
        if lifetime, err := time.ParseDuration(cfg.ConnMaxLifetime); err == nil </span><span class="cov0" title="0">{
                db.SetConnMaxLifetime(lifetime)
        }</span>

        // 测试连接
        <span class="cov0" title="0">if err := db.Ping(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("failed to ping database: %v", err)
        }</span>

        <span class="cov0" title="0">log.Printf("Connected to MySQL database: %s:%s/%s", cfg.Host, cfg.Port, cfg.Name)
        return db, nil</span>
}

func CloseMySQL(db *sql.DB) <span class="cov0" title="0">{
        if db != nil </span><span class="cov0" title="0">{
                if err := db.Close(); err != nil </span><span class="cov0" title="0">{
                        log.Printf("Error closing MySQL connection: %v", err)
                }</span> else<span class="cov0" title="0"> {
                        log.Println("MySQL connection closed")
                }</span>
        }
}
</pre>
		
		<pre class="file" id="file16" style="display: none">package middleware

import (
        "fmt"
        "net/http"
        "time"

        "github.com/gin-gonic/gin"
)

// Logger 日志中间件
func Logger() gin.HandlerFunc <span class="cov0" title="0">{
        return gin.LoggerWithFormatter(func(param gin.LogFormatterParams) string </span><span class="cov0" title="0">{
                return fmt.Sprintf("%s - [%s] \"%s %s %s %d %s \"%s\" %s\"\n",
                        param.ClientIP,
                        param.TimeStamp.Format(time.RFC1123),
                        param.Method,
                        param.Path,
                        param.Request.Proto,
                        param.StatusCode,
                        param.Latency,
                        param.Request.UserAgent(),
                        param.ErrorMessage,
                )
        }</span>)
}

// Recovery 恢复中间件
func Recovery() gin.HandlerFunc <span class="cov0" title="0">{
        return gin.CustomRecovery(func(c *gin.Context, recovered interface{}) </span><span class="cov0" title="0">{
                if err, ok := recovered.(string); ok </span><span class="cov0" title="0">{
                        c.String(http.StatusInternalServerError, fmt.Sprintf("error: %s", err))
                }</span>
                <span class="cov0" title="0">c.AbortWithStatus(http.StatusInternalServerError)</span>
        })
}

// RequestID 请求ID中间件
func RequestID() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                requestID := c.GetHeader("X-Request-ID")
                if requestID == "" </span><span class="cov0" title="0">{
                        requestID = generateRequestID()
                }</span>
                <span class="cov0" title="0">c.Header("X-Request-ID", requestID)
                c.Set("request_id", requestID)
                c.Next()</span>
        }
}

// generateRequestID 生成请求ID
func generateRequestID() string <span class="cov0" title="0">{
        return fmt.Sprintf("req-%d", time.Now().UnixNano())
}</span>

// AuthMiddleware 认证中间件
func AuthMiddleware(redis interface{}) gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                token := c.GetHeader("Authorization")
                if token == "" </span><span class="cov0" title="0">{
                        c.JSON(http.StatusUnauthorized, gin.H{"error": "Authorization header required"})
                        c.Abort()
                        return
                }</span>

                // 这里应该验证JWT token
                // 暂时跳过验证，直接放行
                <span class="cov0" title="0">c.Next()</span>
        }
}

// RateLimit 速率限制中间件
func RateLimit(limit int, window time.Duration) gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                // 这里应该实现速率限制逻辑
                // 暂时跳过，直接放行
                c.Next()
        }</span>
}

// CORS CORS中间件
func CORS() gin.HandlerFunc <span class="cov0" title="0">{
        return func(c *gin.Context) </span><span class="cov0" title="0">{
                c.Header("Access-Control-Allow-Origin", "*")
                c.Header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS")
                c.Header("Access-Control-Allow-Headers", "Origin, Content-Type, Accept, Authorization")
                c.Header("Access-Control-Allow-Credentials", "true")

                if c.Request.Method == "OPTIONS" </span><span class="cov0" title="0">{
                        c.AbortWithStatus(http.StatusNoContent)
                        return
                }</span>

                <span class="cov0" title="0">c.Next()</span>
        }
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>

name: Zervigo Future å¾®æœåŠ¡éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches:
      - main      # ç”Ÿäº§ç¯å¢ƒ
      - develop   # å¼€å‘/æµ‹è¯•ç¯å¢ƒ
    paths:
      - 'backend/**'
      - 'scripts/**'
      - 'docs/**'
      - 'nginx/**'
      - 'docker-compose*.yml'
      - '.github/workflows/zervigo-future-deploy.yml'
  
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      deploy_services:
        description: 'éƒ¨ç½²æœåŠ¡ (é€—å·åˆ†éš”ï¼Œç•™ç©ºéƒ¨ç½²æ‰€æœ‰)'
        required: false
        default: ''
        type: string

env:
  # é˜¿é‡Œäº‘é…ç½®
  ALIBABA_SERVER_IP: ${{ secrets.ALIBABA_SERVER_IP }}
  ALIBABA_SERVER_USER: ${{ secrets.ALIBABA_SERVER_USER }}
  ALIBABA_DEPLOY_PATH: ${{ secrets.ALIBABA_DEPLOY_PATH || '/opt/services' }}
  
  # æœåŠ¡ç«¯å£é…ç½®
  API_GATEWAY_PORT: 8080
  USER_SERVICE_PORT: 8081
  RESUME_SERVICE_PORT: 8082
  COMPANY_SERVICE_PORT: 8083
  NOTIFICATION_SERVICE_PORT: 8084
  TEMPLATE_SERVICE_PORT: 8085
  STATISTICS_SERVICE_PORT: 8086
  BANNER_SERVICE_PORT: 8087
  DEV_TEAM_SERVICE_PORT: 8088
  JOB_SERVICE_PORT: 8089

jobs:
  # æ£€æµ‹å˜æ›´å’Œç¡®å®šéƒ¨ç½²èŒƒå›´
  detect-changes:
    name: ğŸ” æ£€æµ‹ä»£ç å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
      config-changed: ${{ steps.changes.outputs.config }}
      deploy-needed: ${{ steps.check.outputs.deploy-needed }}
      environment: ${{ steps.env.outputs.environment }}
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'pkg/**'
            config:
              - 'configs/**'
              - '**/config.yaml'
            workflow:
              - '.github/workflows/**'
      
      - name: ç¡®å®šéƒ¨ç½²ç¯å¢ƒ
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
          fi
          
          # æ‰‹åŠ¨è§¦å‘æ—¶ä½¿ç”¨è¾“å…¥çš„ç¯å¢ƒ
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          fi
      
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦éƒ¨ç½²
        id: check
        run: |
          if [[ "${{ steps.changes.outputs.backend }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.config }}" == "true" ]] || \
             [[ "${{ steps.changes.outputs.workflow }}" == "true" ]] || \
             [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "deploy-needed=true" >> $GITHUB_OUTPUT
          else
            echo "deploy-needed=false" >> $GITHUB_OUTPUT
          fi

  # æ„å»ºæ‰€æœ‰Goå¾®æœåŠ¡
  build-backend-services:
    name: ğŸ”¨ æ„å»ºGoå¾®æœåŠ¡
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.deploy-needed == 'true'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum
      
      - name: æ„å»ºAPI Gatewayå’Œå¾®æœåŠ¡
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºAPI Gatewayå’Œå¾®æœåŠ¡..."
          go env -w GOPROXY=https://goproxy.cn,direct
          
          # åˆ›å»ºbinç›®å½•
          mkdir -p backend/bin
          
          # ========================================
          # é˜¶æ®µ1: æ„å»ºAPI Gateway (ç½‘å…³å±‚)
          # ========================================
          echo "ğŸŒ æ„å»ºAPI Gateway (ç½‘å…³å±‚)..."
          cd backend
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o bin/api-gateway ./cmd/api-gateway
          echo "âœ… API Gatewayæ„å»ºå®Œæˆ"
          
          # ========================================
          # é˜¶æ®µ2: æ„å»ºå¾®æœåŠ¡ (ä¸šåŠ¡å±‚)
          # ========================================
          echo "ğŸ’¼ æ„å»ºå¾®æœåŠ¡ (ä¸šåŠ¡å±‚)..."
          
          # æ„å»ºUser Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º User Service..."
          cd internal/user-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/user-service .
          cd ../..
          
          # æ„å»ºResume Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Resume Service..."
          cd internal/resume-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/resume-service .
          cd ../..
          
          # æ„å»ºCompany Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Company Service..."
          cd internal/company-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/company-service .
          cd ../..
          
          # æ„å»ºNotification Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Notification Service..."
          cd internal/notification-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/notification-service .
          cd ../..
          
          # æ„å»ºTemplate Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Template Service..."
          cd internal/template-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/template-service .
          cd ../..
          
          # æ„å»ºStatistics Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Statistics Service..."
          cd internal/statistics-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/statistics-service .
          cd ../..
          
          # æ„å»ºBanner Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Banner Service..."
          cd internal/banner-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/banner-service .
          cd ../..
          
          # æ„å»ºDev Team Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Dev Team Service..."
          cd internal/dev-team-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/dev-team-service .
          cd ../..
          
          # æ„å»ºJob Service (ä½¿ç”¨jobfirst-coreè®¤è¯)
          echo "æ„å»º Job Service..."
          cd internal/job-service
          go mod download
          go mod verify
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -installsuffix cgo \
            -ldflags="-s -w" -o ../../bin/job-service .
          cd ../..
          
          echo "âœ… æ‰€æœ‰æœåŠ¡æ„å»ºå®Œæˆ"
          echo ""
          echo "ğŸ“Š æ„å»ºç»“æœ:"
          ls -lh bin/
          echo ""
          echo "ğŸ—ï¸ æ¶æ„è¯´æ˜:"
          echo "  ğŸŒ API Gateway (8080) - é‡å­è®¤è¯ + åå‘ä»£ç†"
          echo "  ğŸ’¼ å¾®æœåŠ¡ (8081-8089) - jobfirst-coreè®¤è¯ + ä¸šåŠ¡é€»è¾‘"
      
      - name: ä¸Šä¼ å¾®æœåŠ¡ä»£ç å’Œè„šæœ¬
        uses: actions/upload-artifact@v4
        with:
          name: backend-services
          path: backend/
          retention-days: 7

  # éƒ¨ç½²åˆ°é˜¿é‡Œäº‘
  deploy-to-alibaba:
    name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘
    runs-on: ubuntu-latest
    needs: [detect-changes, build-backend-services]
    if: needs.detect-changes.outputs.deploy-needed == 'true'
    
    steps:
      - name: Checkoutä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½å¾®æœåŠ¡ä»£ç å’Œè„šæœ¬
        uses: actions/download-artifact@v4
        with:
          name: backend-services
          path: backend-services/
      
      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ALIBABA_SSH_PRIVATE_KEY }}" > ~/.ssh/alibaba_key
          chmod 600 ~/.ssh/alibaba_key
          ssh-keyscan -H ${{ env.ALIBABA_SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: ä¸Šä¼ æœåŠ¡æ–‡ä»¶
        run: |
          echo "ğŸ“¤ ä¸Šä¼ å¾®æœåŠ¡æ–‡ä»¶åˆ°é˜¿é‡Œäº‘..."
          
          # åˆ›å»ºè¿œç¨‹ç›®å½•ç»“æ„ï¼ˆåŒ…æ‹¬æ‰€æœ‰éœ€è¦çš„å­ç›®å½•ï¼‰
          ssh -i ~/.ssh/alibaba_key \
            ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} \
            "mkdir -p ${{ env.ALIBABA_DEPLOY_PATH }}/{backend/{cmd/api-gateway,internal/{user-service,resume-service,company-service,notification-service,template-service,statistics-service,banner-service,dev-team-service,job-service},pkg,scripts/services,bin},configs,logs,scripts}"
          
          # ä¸Šä¼ å¾®æœåŠ¡æºä»£ç ï¼ˆä¿æŒç›®å½•ç»“æ„ï¼‰
          echo "ä¸Šä¼ åç«¯ä»£ç ..."
          tar -czf backend-code.tar.gz -C backend-services .
          scp -i ~/.ssh/alibaba_key backend-code.tar.gz \
            ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/backend/
          
          # åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šè§£å‹
          ssh -i ~/.ssh/alibaba_key \
            ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} \
            "cd ${{ env.ALIBABA_DEPLOY_PATH }}/backend && tar -xzf backend-code.tar.gz && rm backend-code.tar.gz"
          
          # ç”Ÿæˆç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶
          echo "ç”Ÿæˆç¯å¢ƒç‰¹å®šçš„é…ç½®æ–‡ä»¶..."
          chmod +x scripts/generate-configs.sh
          ./scripts/generate-configs.sh configs/templates/aliyun.env.template
          
          # ä¸Šä¼ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶
          if [ -d "configs/generated" ]; then
            echo "ä¸Šä¼ ç”Ÿæˆçš„é…ç½®æ–‡ä»¶..."
            scp -i ~/.ssh/alibaba_key -r configs/generated/* \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/configs/ || echo "âš ï¸ é…ç½®æ–‡ä»¶ä¸Šä¼ å¤±è´¥æˆ–ä¸å­˜åœ¨"
            
            # ç‰¹åˆ«ä¸Šä¼ jobfirst-core-config.yamlåˆ°backend/configsç›®å½•
            if [ -f "configs/generated/jobfirst-core-config.yaml" ]; then
              echo "ä¸Šä¼ æ ¸å¿ƒé…ç½®æ–‡ä»¶jobfirst-core-config.yaml..."
              scp -i ~/.ssh/alibaba_key configs/generated/jobfirst-core-config.yaml \
                ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/backend/configs/jobfirst-core-config.yaml
            fi
          fi
          
          # ä¸Šä¼ æ•°æ®åº“è„šæœ¬ï¼ˆä½¿ç”¨taræ–¹å¼é¿å…SCPç›®å½•æƒé™é—®é¢˜ï¼‰
          if [ -d "database" ]; then
            echo "ä¸Šä¼ æ•°æ®åº“è„šæœ¬..."
            tar -czf database.tar.gz -C . database/
            scp -i ~/.ssh/alibaba_key database.tar.gz \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/
            ssh -i ~/.ssh/alibaba_key \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} \
              "cd ${{ env.ALIBABA_DEPLOY_PATH }} && tar -xzf database.tar.gz && rm database.tar.gz"
          else
            echo "âš ï¸ databaseç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ•°æ®åº“è„šæœ¬ä¸Šä¼ "
          fi
          
          # ä¸Šä¼ è„šæœ¬æ–‡ä»¶ï¼ˆä½¿ç”¨taræ–¹å¼é¿å…SCPç›®å½•æƒé™é—®é¢˜ï¼‰
          if [ -d "scripts" ]; then
            echo "ä¸Šä¼ è„šæœ¬æ–‡ä»¶..."
            tar -czf scripts.tar.gz -C . scripts/
            scp -i ~/.ssh/alibaba_key scripts.tar.gz \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/
            ssh -i ~/.ssh/alibaba_key \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} \
              "cd ${{ env.ALIBABA_DEPLOY_PATH }} && tar -xzf scripts.tar.gz && rm scripts.tar.gz"
          else
            echo "âš ï¸ scriptsç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡è„šæœ¬æ–‡ä»¶ä¸Šä¼ "
          fi
          
          # ä¸Šä¼ nginxé…ç½®
          if [ -d "nginx" ]; then
            echo "ä¸Šä¼ nginxé…ç½®..."
            tar -czf nginx.tar.gz -C . nginx/
            scp -i ~/.ssh/alibaba_key nginx.tar.gz \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }}:${{ env.ALIBABA_DEPLOY_PATH }}/
            ssh -i ~/.ssh/alibaba_key \
              ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} \
              "cd ${{ env.ALIBABA_DEPLOY_PATH }} && tar -xzf nginx.tar.gz && rm nginx.tar.gz"
          else
            echo "âš ï¸ nginxç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡nginxé…ç½®ä¸Šä¼ "
          fi
          
          echo "âœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆ"
      
      - name: éƒ¨ç½²å¾®æœåŠ¡ (æŒ‰æ—¶åº)
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²å¾®æœåŠ¡..."
          
          ssh -i ~/.ssh/alibaba_key \
            ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} << 'ENDSSH'
          
          cd ${{ env.ALIBABA_DEPLOY_PATH }}
          
          # ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ‰§è¡Œæƒé™
          chmod +x backend/bin/*
          
          # åœæ­¢ç°æœ‰å¾®æœåŠ¡
          echo "â¸ï¸  åœæ­¢ç°æœ‰å¾®æœåŠ¡..."
          pkill -f api-gateway || true
          pkill -f user-service || true
          pkill -f resume-service || true
          pkill -f company-service || true
          pkill -f notification-service || true
          pkill -f template-service || true
          pkill -f statistics-service || true
          pkill -f banner-service || true
          pkill -f dev-team-service || true
          pkill -f job-service || true
          
          sleep 5
          
          # åˆ›å»ºæ—¥å¿—ç›®å½•
          mkdir -p logs
          
          # è®¾ç½®æ•°æ®åº“
          echo "ğŸ”§ è®¾ç½®æ•°æ®åº“..."
          chmod +x scripts/setup-databases.sh
          ./scripts/setup-databases.sh configs/.env || echo "âš ï¸ æ•°æ®åº“è®¾ç½®å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
          
          # éƒ¨ç½²nginxé…ç½®
          echo "ğŸŒ éƒ¨ç½²nginxé…ç½®..."
          if [ -d "nginx" ]; then
            echo "å¤‡ä»½ç°æœ‰nginxé…ç½®..."
            cp /etc/nginx/conf.d/looma.conf /etc/nginx/conf.d/looma.conf.backup.$(date +%Y%m%d_%H%M%S) || echo "å¤‡ä»½å¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
            
            echo "éƒ¨ç½²æ–°çš„nginxé…ç½®..."
            cp nginx/conf.d/aliyun-microservices.conf /etc/nginx/conf.d/aliyun-microservices.conf
            
            echo "æµ‹è¯•nginxé…ç½®..."
            nginx -t && echo "âœ… nginxé…ç½®æµ‹è¯•é€šè¿‡" || echo "âŒ nginxé…ç½®æµ‹è¯•å¤±è´¥"
            
            echo "é‡è½½nginxé…ç½®..."
            systemctl reload nginx && echo "âœ… nginxé…ç½®é‡è½½æˆåŠŸ" || echo "âŒ nginxé…ç½®é‡è½½å¤±è´¥"
          else
            echo "âš ï¸ nginxç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡nginxé…ç½®éƒ¨ç½²"
          fi
          
          # ========================================
          # é˜¶æ®µ1: å¯åŠ¨API Gateway (ç½‘å…³å±‚)
          # ========================================
          echo "ğŸŒ å¯åŠ¨API Gateway (ç½‘å…³å±‚)..."
          echo "èŒè´£: é‡å­è®¤è¯ + åå‘ä»£ç† + ç»Ÿä¸€å…¥å£"
          cd backend/bin
          
          # API Gateway (8080) - é‡å­è®¤è¯ + åå‘ä»£ç†
          echo "å¯åŠ¨ API Gateway (8080)..."
          nohup ./api-gateway > ../../logs/api-gateway.log 2>&1 &
          echo $! > ../../logs/api-gateway.pid
          sleep 10
          curl -f http://localhost:8080/health && echo "âœ… API Gateway OK" || echo "âŒ API Gateway Failed"
          
          # ========================================
          # é˜¶æ®µ2: å¯åŠ¨å¾®æœåŠ¡ (ä¸šåŠ¡å±‚)
          # ========================================
          echo "ğŸ’¼ å¯åŠ¨å¾®æœåŠ¡ (ä¸šåŠ¡å±‚)..."
          echo "èŒè´£: jobfirst-coreè®¤è¯ + ä¸šåŠ¡é€»è¾‘ + ä¿¡ä»»ç½‘å…³Header"
          
          # User Service (8081) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ User Service (8081)..."
          nohup ./user-service > ../../logs/user-service.log 2>&1 &
          echo $! > ../../logs/user-service.pid
          sleep 10
          curl -f http://localhost:8081/health && echo "âœ… User Service OK" || echo "âŒ User Service Failed"
          
          # Resume Service (8082) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Resume Service (8082)..."
          nohup ./resume-service > ../../logs/resume-service.log 2>&1 &
          echo $! > ../../logs/resume-service.pid
          sleep 5
          curl -f http://localhost:8082/health && echo "âœ… Resume Service OK" || echo "âŒ Resume Service Failed"
          
          # Company Service (8083) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Company Service (8083)..."
          nohup ./company-service > ../../logs/company-service.log 2>&1 &
          echo $! > ../../logs/company-service.pid
          sleep 5
          curl -f http://localhost:8083/health && echo "âœ… Company Service OK" || echo "âŒ Company Service Failed"
          
          # Notification Service (8084) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Notification Service (8084)..."
          nohup ./notification-service > ../../logs/notification-service.log 2>&1 &
          echo $! > ../../logs/notification-service.pid
          sleep 3
          curl -f http://localhost:8084/health && echo "âœ… Notification Service OK" || echo "âŒ Notification Service Failed"
          
          # Template Service (8085) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Template Service (8085)..."
          nohup ./template-service > ../../logs/template-service.log 2>&1 &
          echo $! > ../../logs/template-service.pid
          sleep 3
          curl -f http://localhost:8085/health && echo "âœ… Template Service OK" || echo "âŒ Template Service Failed"
          
          # Statistics Service (8086) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Statistics Service (8086)..."
          nohup ./statistics-service > ../../logs/statistics-service.log 2>&1 &
          echo $! > ../../logs/statistics-service.pid
          sleep 3
          curl -f http://localhost:8086/health && echo "âœ… Statistics Service OK" || echo "âŒ Statistics Service Failed"
          
          # Banner Service (8087) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Banner Service (8087)..."
          nohup ./banner-service > ../../logs/banner-service.log 2>&1 &
          echo $! > ../../logs/banner-service.pid
          sleep 3
          curl -f http://localhost:8087/health && echo "âœ… Banner Service OK" || echo "âŒ Banner Service Failed"
          
          # Dev Team Service (8088) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Dev Team Service (8088)..."
          nohup ./dev-team-service > ../../logs/dev-team-service.log 2>&1 &
          echo $! > ../../logs/dev-team-service.pid
          sleep 3
          curl -f http://localhost:8088/health && echo "âœ… Dev Team Service OK" || echo "âŒ Dev Team Service Failed"
          
          # Job Service (8089) - jobfirst-coreè®¤è¯
          echo "å¯åŠ¨ Job Service (8089)..."
          nohup ./job-service > ../../logs/job-service.log 2>&1 &
          echo $! > ../../logs/job-service.pid
          sleep 3
          curl -f http://localhost:8089/health && echo "âœ… Job Service OK" || echo "âŒ Job Service Failed"
          
          echo ""
          echo "=========================================="
          echo "âœ… æ‰€æœ‰æœåŠ¡éƒ¨ç½²å®Œæˆï¼"
          echo "=========================================="
          echo ""
          echo "ğŸ—ï¸ æ¶æ„è¯´æ˜:"
          echo "  ğŸŒ API Gateway (8080) - é‡å­è®¤è¯ + åå‘ä»£ç† + ç»Ÿä¸€å…¥å£"
          echo "  ğŸ’¼ å¾®æœåŠ¡ (8081-8089) - jobfirst-coreè®¤è¯ + ä¸šåŠ¡é€»è¾‘"
          echo ""
          echo "ğŸ” è®¤è¯æµç¨‹:"
          echo "  1. å¤–éƒ¨è¯·æ±‚ â†’ API Gateway (é‡å­è®¤è¯)"
          echo "  2. API Gateway â†’ å¾®æœåŠ¡ (æ·»åŠ X-User-* Headers)"
          echo "  3. å¾®æœåŠ¡ â†’ ä¿¡ä»»ç½‘å…³Headeræˆ–ä½¿ç”¨jobfirst-coreè®¤è¯"
          echo ""
          echo "ğŸ“¡ è®¿é—®æ–¹å¼:"
          echo "  - é€šè¿‡ç½‘å…³: http://47.115.168.107:8080/api/v1/*"
          echo "  - ç›´æ¥è®¿é—®: http://47.115.168.107:8081-8089/api/v1/*"
          
          ENDSSH
      
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/alibaba_key

  # éªŒè¯éƒ¨ç½²
  verify-deployment:
    name: âœ… éªŒè¯éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-to-alibaba]
    if: needs.detect-changes.outputs.deploy-needed == 'true'
    
    steps:
      - name: é…ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ALIBABA_SSH_PRIVATE_KEY }}" > ~/.ssh/alibaba_key
          chmod 600 ~/.ssh/alibaba_key
          ssh-keyscan -H ${{ env.ALIBABA_SERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: éªŒè¯æ‰€æœ‰æœåŠ¡
        run: |
          echo "âœ… éªŒè¯å¾®æœåŠ¡éƒ¨ç½²çŠ¶æ€..."
          
          ssh -i ~/.ssh/alibaba_key \
            ${{ env.ALIBABA_SERVER_USER }}@${{ env.ALIBABA_SERVER_IP }} << 'ENDSSH'
          
          echo "=========================================="
          echo "ğŸ” å¾®æœåŠ¡å¥åº·æ£€æŸ¥"
          echo "=========================================="
          
          # ç½‘å…³å±‚
          echo ""
          echo "=== ç½‘å…³å±‚ ==="
          curl -f http://localhost:8080/health && echo "âœ… API Gateway (8080)" || echo "âŒ API Gateway (8080)"
          
          # è®¤è¯æˆæƒå±‚
          echo ""
          echo "=== è®¤è¯æˆæƒå±‚ ==="
          curl -f http://localhost:8081/health && echo "âœ… User Service (8081)" || echo "âŒ User Service (8081)"
          
          # æ ¸å¿ƒä¸šåŠ¡å±‚
          echo ""
          echo "=== æ ¸å¿ƒä¸šåŠ¡å±‚ ==="
          curl -f http://localhost:8082/health && echo "âœ… Resume Service (8082)" || echo "âŒ Resume Service (8082)"
          curl -f http://localhost:8083/health && echo "âœ… Company Service (8083)" || echo "âŒ Company Service (8083)"
          
          # æ”¯æ’‘æœåŠ¡å±‚
          echo ""
          echo "=== æ”¯æ’‘æœåŠ¡å±‚ ==="
          curl -f http://localhost:8084/health && echo "âœ… Notification Service (8084)" || echo "âŒ Notification Service (8084)"
          curl -f http://localhost:8085/health && echo "âœ… Template Service (8085)" || echo "âŒ Template Service (8085)"
          curl -f http://localhost:8086/health && echo "âœ… Statistics Service (8086)" || echo "âŒ Statistics Service (8086)"
          curl -f http://localhost:8087/health && echo "âœ… Banner Service (8087)" || echo "âŒ Banner Service (8087)"
          
          # ç®¡ç†æœåŠ¡å±‚
          echo ""
          echo "=== ç®¡ç†æœåŠ¡å±‚ ==="
          curl -f http://localhost:8088/health && echo "âœ… Dev Team Service (8088)" || echo "âŒ Dev Team Service (8088)"
          curl -f http://localhost:8089/health && echo "âœ… Job Service (8089)" || echo "âŒ Job Service (8089)"
          
          # AIæœåŠ¡ (å·²é¢„éƒ¨ç½²)
          echo ""
          echo "=== AIæœåŠ¡å±‚ (é¢„éƒ¨ç½²) ==="
          curl -f http://localhost:8100/health && echo "âœ… AI Service (8100)" || echo "âŒ AI Service (8100)"
          
          # æ•°æ®åº“ (å·²é¢„éƒ¨ç½²)
          echo ""
          echo "=== æ•°æ®åº“å±‚ (é¢„éƒ¨ç½²) ==="
          podman exec migration-mysql mysql -uroot -pJobFirst2025!MySQL -e "SELECT 'MySQL OK' as status;" 2>/dev/null && echo "âœ… MySQL (3306)" || echo "âŒ MySQL (3306)"
          podman exec migration-postgres psql -U postgres -c "SELECT 'PostgreSQL OK' as status;" 2>/dev/null && echo "âœ… PostgreSQL (5432)" || echo "âŒ PostgreSQL (5432)"
          podman exec migration-redis redis-cli -a JobFirst2025!Redis ping 2>/dev/null && echo "âœ… Redis (6379)" || echo "âŒ Redis (6379)"
          podman exec migration-mongodb mongosh -u admin -p'JobFirst2025!Mongo' --authenticationDatabase admin --eval "db.version()" --quiet 2>/dev/null && echo "âœ… MongoDB (27017)" || echo "âŒ MongoDB (27017)"
          
          echo ""
          echo "=========================================="
          echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
          echo "=========================================="
          
          ENDSSH
      
      - name: æ¸…ç†SSHå¯†é’¥
        if: always()
        run: |
          rm -f ~/.ssh/alibaba_key

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [detect-changes, verify-deployment]
    if: always() && needs.detect-changes.outputs.deploy-needed == 'true'
    
    steps:
      - name: éƒ¨ç½²ç»“æœ
        run: |
          if [[ "${{ needs.verify-deployment.result }}" == "success" ]]; then
            echo "âœ… Zervigo Futureå¾®æœåŠ¡éƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ç¯å¢ƒ: ${{ needs.detect-changes.outputs.environment }}"
            echo "æäº¤: ${{ github.sha }}"
            echo "åˆ†æ”¯: ${{ github.ref_name }}"
            echo ""
            echo "=========================================="
            echo "å·²éƒ¨ç½²çš„å¾®æœåŠ¡:"
            echo "=========================================="
            echo ""
            echo "ç½‘å…³å±‚:"
            echo "  - API Gateway (8080)"
            echo ""
            echo "è®¤è¯æˆæƒå±‚:"
            echo "  - User Service (8081)"
            echo ""
            echo "æ ¸å¿ƒä¸šåŠ¡å±‚:"
            echo "  - Resume Service (8082)"
            echo "  - Company Service (8083)"
            echo ""
            echo "æ”¯æ’‘æœåŠ¡å±‚:"
            echo "  - Notification Service (8084)"
            echo "  - Template Service (8085)"
            echo "  - Statistics Service (8086)"
            echo "  - Banner Service (8087)"
            echo ""
            echo "ç®¡ç†æœåŠ¡å±‚:"
            echo "  - Dev Team Service (8088)"
            echo "  - Job Service (8089)"
            echo ""
            echo "=========================================="
            echo "é¢„éƒ¨ç½²æœåŠ¡ (æ— éœ€æµæ°´çº¿éƒ¨ç½²):"
            echo "=========================================="
            echo "  - AI Service (8100)"
            echo "  - MySQL (3306)"
            echo "  - PostgreSQL (5432)"
            echo "  - Redis (6379)"
            echo "  - MongoDB (27017)"
            echo ""
            echo "=========================================="
            echo "è®¿é—®åœ°å€:"
            echo "=========================================="
            echo "  - API Gateway: http://${{ env.ALIBABA_SERVER_IP }}:8080"
            echo "  - User Service: http://${{ env.ALIBABA_SERVER_IP }}:8081"
            echo "  - Resume Service: http://${{ env.ALIBABA_SERVER_IP }}:8082"
            echo "  - Company Service: http://${{ env.ALIBABA_SERVER_IP }}:8083"
            echo "  - Notification Service: http://${{ env.ALIBABA_SERVER_IP }}:8084"
            echo "  - Template Service: http://${{ env.ALIBABA_SERVER_IP }}:8085"
            echo "  - Statistics Service: http://${{ env.ALIBABA_SERVER_IP }}:8086"
            echo "  - Banner Service: http://${{ env.ALIBABA_SERVER_IP }}:8087"
            echo "  - Dev Team Service: http://${{ env.ALIBABA_SERVER_IP }}:8088"
            echo "  - Job Service: http://${{ env.ALIBABA_SERVER_IP }}:8089"
            echo "  - AI Service: http://${{ env.ALIBABA_SERVER_IP }}:8100"
          else
            echo "âŒ Zervigo Futureå¾®æœåŠ¡éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—æ’æŸ¥é—®é¢˜"
            exit 1
          fi